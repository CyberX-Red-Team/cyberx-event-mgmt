name: Prepare Blueprint for Import

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Which environment Blueprint to prepare'
        required: true
        type: choice
        options:
          - staging
          - production
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - activate
          - restore

jobs:
  swap-blueprint:
    name: Swap render.yaml
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Activate environment Blueprint
        if: ${{ github.event.inputs.action == 'activate' }}
        run: |
          echo "üîÑ Activating ${{ github.event.inputs.environment }} Blueprint..."

          if [ "${{ github.event.inputs.environment }}" = "staging" ]; then
            # Copy staging to render.yaml
            if [ -f render-staging.yaml ]; then
              cp render-staging.yaml render.yaml
              echo "‚úÖ Copied render-staging.yaml to render.yaml"
            else
              echo "‚ùå render-staging.yaml not found"
              exit 1
            fi
          elif [ "${{ github.event.inputs.environment }}" = "production" ]; then
            # Copy production to render.yaml
            if [ -f render-production.yaml ]; then
              cp render-production.yaml render.yaml
              echo "‚úÖ Copied render-production.yaml to render.yaml"
            else
              echo "‚ùå render-production.yaml not found"
              exit 1
            fi
          fi

          # Show what changed
          echo "üìÑ render.yaml now contains ${{ github.event.inputs.environment }} configuration"

      - name: Restore generic Blueprint
        if: ${{ github.event.inputs.action == 'restore' }}
        run: |
          echo "üîÑ Restoring generic render.yaml..."

          if [ -f render-generic.yaml.backup ]; then
            cp render-generic.yaml.backup render.yaml
            echo "‚úÖ Restored render.yaml from backup"
          else
            echo "‚ö†Ô∏è No backup found, removing render.yaml"
            rm -f render.yaml
          fi

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add render.yaml

          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è No changes to commit"
          else
            if [ "${{ github.event.inputs.action }}" = "activate" ]; then
              git commit -m "Prepare Blueprint: activate ${{ github.event.inputs.environment }} configuration

This prepares render.yaml for Blueprint import in Render dashboard.
Temporary change - run 'restore' action after importing.

Triggered by: ${{ github.actor }}
Action: ${{ github.event.inputs.action }}
Environment: ${{ github.event.inputs.environment }}
"
            else
              git commit -m "Restore Blueprint: reset render.yaml

Restored render.yaml after Blueprint import.

Triggered by: ${{ github.actor }}
Action: ${{ github.event.inputs.action }}
"
            fi

            git push
            echo "‚úÖ Changes pushed to repository"
          fi

      - name: Next steps
        if: ${{ github.event.inputs.action == 'activate' }}
        run: |
          echo "üéØ Next Steps:"
          echo ""
          echo "1. Go to Render Dashboard: https://dashboard.render.com"
          echo "2. Click 'New' ‚Üí 'Blueprint'"
          echo "3. Select your repository: CyberX-Red-Team/cyberx-event-mgmt"
          echo "4. Render will use render.yaml (now configured for ${{ github.event.inputs.environment }})"
          echo "5. Click 'Apply' to create/update services"
          echo ""
          echo "‚ö†Ô∏è After importing, run this workflow again with 'restore' action"
          echo "   to reset render.yaml"

      - name: Completion message
        if: ${{ github.event.inputs.action == 'restore' }}
        run: |
          echo "‚úÖ Blueprint restored!"
          echo "render.yaml has been reset to generic/backup state"
