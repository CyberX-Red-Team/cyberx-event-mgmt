name: Deploy to Production

# Production deploys from main branch only
# Triggered by: version tags (v*) or manual workflow dispatch
on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - deploy
          - resume
          - suspend
      skip_tests:
        description: 'Skip tests (use for resume/suspend only)'
        required: false
        type: boolean
        default: false

env:
  RENDER_SERVICE_NAME: cyberx-production

jobs:
  test:
    name: Run Tests
    if: ${{ !inputs.skip_tests }}
    uses: ./.github/workflows/test.yml

  backup-production:
    name: Backup Production Database
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.action != 'suspend' && github.event.inputs.action != 'resume' }}
    needs: test

    steps:
      - name: Create Supabase backup
        env:
          SUPABASE_PROJECT_REF: ${{ secrets.PRODUCTION_SUPABASE_PROJECT_REF }}
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          echo "üì¶ Creating production database backup..."

          RESPONSE=$(curl -X POST \
            "https://api.supabase.com/v1/projects/${SUPABASE_PROJECT_REF}/database/backups" \
            -H "Authorization: Bearer ${SUPABASE_ACCESS_TOKEN}" \
            -H "Content-Type: application/json")

          echo "Backup response: $RESPONSE"
          echo "‚úÖ Backup initiated!"

      - name: Wait for backup completion
        env:
          SUPABASE_PROJECT_REF: ${{ secrets.PRODUCTION_SUPABASE_PROJECT_REF }}
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          echo "‚è≥ Waiting for backup to complete..."
          sleep 60
          echo "‚úÖ Backup should be complete"

  deploy-production:
    name: Deploy to Production
    needs: [test, backup-production]
    if: |
      always() &&
      (needs.test.result == 'success' || needs.test.result == 'skipped') &&
      (needs.backup-production.result == 'success' || needs.backup-production.result == 'skipped') &&
      (github.event.inputs.action == 'deploy' || github.event.inputs.action == '' || startsWith(github.ref, 'refs/tags/v'))
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://events.cyberxredteam.org

    steps:
      - name: Trigger Render Deploy via Deploy Hook
        env:
          PRODUCTION_DEPLOY_HOOK_URL: ${{ secrets.PRODUCTION_DEPLOY_HOOK_URL }}
        run: |
          echo "üöÄ Triggering Render deployment for production..."
          echo "Note: Database migrations will run automatically (alembic upgrade head)"
          echo "Note: DATABASE_URL is configured in Render dashboard"

          # Trigger web service deployment and capture response
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "${PRODUCTION_DEPLOY_HOOK_URL}")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)

          echo "Response: $BODY"

          # Extract deploy ID from JSON response
          DEPLOY_ID=$(echo "$BODY" | grep -o '"id":"[^"]*"' | cut -d'"' -f4)

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ] && [ -n "$DEPLOY_ID" ]; then
            echo "‚úÖ Deployment triggered (Deploy ID: $DEPLOY_ID)"
          else
            echo "‚ùå Deployment failed (HTTP $HTTP_CODE)"
            exit 1
          fi

      - name: Wait for deployment
        run: |
          echo "‚è≥ Waiting for deployment to complete..."
          echo "Render is building and deploying the application..."

          # Wait 2 minutes for Render to build and start deploying
          sleep 120

      - name: Run health check
        run: |
          echo "üè• Running production health check..."

          MAX_RETRIES=10
          RETRY_DELAY=15

          for i in $(seq 1 $MAX_RETRIES); do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              https://events.cyberxredteam.org/health)

            if [ "$HTTP_CODE" -eq 200 ]; then
              echo "‚úÖ Health check passed!"

              # Get detailed health info
              HEALTH=$(curl -s https://events.cyberxredteam.org/health)
              echo "Health details: $HEALTH"
              exit 0
            fi

            echo "‚è≥ Attempt $i/$MAX_RETRIES failed (HTTP $HTTP_CODE), retrying in ${RETRY_DELAY}s..."
            sleep $RETRY_DELAY
          done

          echo "‚ùå Health check failed after $MAX_RETRIES attempts"
          exit 1

      - name: Run production smoke tests
        run: |
          echo "üî• Running production smoke tests..."

          BASE_URL="https://events.cyberxredteam.org"

          # Test API docs
          echo "Testing API docs..."
          curl -f "${BASE_URL}/api/docs" || exit 1

          # Test database connectivity (via health endpoint)
          echo "Testing database connection..."
          HEALTH=$(curl -s "${BASE_URL}/health")
          DB_STATUS=$(echo "$HEALTH" | jq -r '.database // "unknown"')

          if [ "$DB_STATUS" != "connected" ] && [ "$DB_STATUS" != "unknown" ]; then
            echo "‚ùå Database not connected: $DB_STATUS"
            exit 1
          fi

          echo "‚úÖ All production smoke tests passed!"

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          body: |
            ## üöÄ Production Release

            **Deployed to:** https://events.cyberxredteam.org
            **Tag:** ${{ github.ref_name }}
            **Commit:** ${{ github.sha }}

            ### Changes
            See commit history for details.

            ### Deployment Info
            - Database migrations: ‚úÖ Applied
            - Health checks: ‚úÖ Passed
            - Smoke tests: ‚úÖ Passed

            **Generated by GitHub Actions**
          draft: false
          prerelease: false

      - name: Notify deployment success
        if: success()
        run: |
          echo "üéâ Production deployment successful!"
          echo "URL: https://events.cyberxredteam.org"
          echo "Tag: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"

      - name: Rollback on failure
        if: failure()
        run: |
          echo "‚ùå Deployment failed! Initiating rollback..."
          echo "‚ö†Ô∏è Manual intervention required"
          echo "Check Render dashboard: https://dashboard.render.com"
          echo "Options:"
          echo "  1. Restore from Supabase backup if needed"
          echo "  2. Roll back to previous version in Render dashboard"
          echo "  3. Check logs for deployment errors"

  resume-production:
    name: Resume Production Service
    if: github.event.inputs.action == 'resume'
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://events.cyberxredteam.org

    steps:
      - name: Resume Render service
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.PRODUCTION_RENDER_SERVICE_ID }}
        run: |
          echo "‚ñ∂Ô∏è Resuming production service..."

          curl -X POST \
            "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/resume" \
            -H "Authorization: Bearer ${RENDER_API_KEY}"

          echo "‚è≥ Waiting for service to start..."
          sleep 120

      - name: Verify service resumed
        run: |
          echo "üîç Verifying service is running..."

          MAX_RETRIES=10
          for i in $(seq 1 $MAX_RETRIES); do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              https://events.cyberxredteam.org/health)

            if [ "$HTTP_CODE" -eq 200 ]; then
              echo "‚úÖ Service resumed successfully!"
              exit 0
            fi

            echo "‚è≥ Attempt $i/$MAX_RETRIES, waiting..."
            sleep 15
          done

          echo "‚ùå Failed to verify service resumed"
          exit 1

  suspend-production:
    name: Suspend Production Service
    if: github.event.inputs.action == 'suspend'
    runs-on: ubuntu-latest
    environment:
      name: production-suspend

    steps:
      - name: Verify safe to suspend
        run: |
          echo "‚ö†Ô∏è About to suspend production service"
          echo "This will stop all traffic to the application"
          echo "Billing will pause until service is resumed"

      - name: Suspend Render service
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.PRODUCTION_RENDER_SERVICE_ID }}
        run: |
          echo "‚è∏Ô∏è Suspending production service..."

          curl -X POST \
            "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/suspend" \
            -H "Authorization: Bearer ${RENDER_API_KEY}"

          echo "‚úÖ Service suspended!"
          echo "üí∞ Billing paused"
          echo "üìä Database (Supabase) remains active"

      - name: Verify service suspended
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.PRODUCTION_RENDER_SERVICE_ID }}
        run: |
          echo "üîç Verifying service is suspended..."

          sleep 30

          SERVICE_INFO=$(curl -s -H "Authorization: Bearer ${RENDER_API_KEY}" \
            "https://api.render.com/v1/services/${RENDER_SERVICE_ID}")

          SUSPENDED=$(echo "$SERVICE_INFO" | jq -r '.service.suspended')

          if [ "$SUSPENDED" = "suspended" ] || [ "$SUSPENDED" = "true" ]; then
            echo "‚úÖ Service confirmed suspended"
            echo "Resume anytime with: Actions ‚Üí Deploy to Production ‚Üí Run workflow ‚Üí resume"
          else
            echo "‚ö†Ô∏è Service suspension status unclear: $SUSPENDED"
          fi
