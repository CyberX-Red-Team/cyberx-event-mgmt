{% extends "layouts/dashboard.html" %}

{% block title %}Email Center{% endblock %}

{% block extra_css %}
<style>
/* Email Center Tab Styling - tabs extend upward */
#emailTabs {
    border-bottom: none;
    margin: 0;
}

#emailTabs .nav-item {
    margin-bottom: 0;
}

#emailTabs .nav-link {
    border: 1px solid transparent;
    border-bottom: none;
    border-radius: 0.375rem 0.375rem 0 0;
    padding: 0.75rem 1.25rem;
    color: #6c757d;
    background: transparent;
    margin-top: 0.5rem;
    transition: all 0.15s ease-in-out;
}

#emailTabs .nav-link:hover {
    color: #0061f2;
    border-color: transparent;
}

#emailTabs .nav-link.active {
    color: #0061f2;
    background-color: #fff;
    border-color: #dee2e6 #dee2e6 #fff;
    margin-top: 0;
    padding-top: 1rem;
    font-weight: 600;
}

/* Card header adjustment for tabs */
.card-header.p-0 {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
    padding-left: 0.5rem !important;
}

/* Spin animation for refresh button */
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.spin-animation {
    animation: spin 1s linear infinite;
}
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<header class="page-header page-header-dark bg-gradient-primary-to-secondary pb-10">
    <div class="container-fluid px-4">
        <div class="page-header-content pt-4">
            <div class="row align-items-center justify-content-between">
                <div class="col-auto mt-4">
                    <h1 class="page-header-title">
                        <div class="page-header-icon"><i data-feather="mail"></i></div>
                        Email Center
                    </h1>
                    <div class="page-header-subtitle">Send emails, manage templates, and track delivery analytics</div>
                </div>
                <div class="col-12 col-xl-auto mt-4">
                    <button class="btn btn-sm btn-light" onclick="openTestEmailModal()">
                        <i data-feather="zap" class="me-1"></i>
                        Send Test Email
                    </button>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Main Content -->
<div class="container-fluid px-4 mt-n10">
    <!-- Tab Navigation -->
    <div class="card mb-4">
        <div class="card-header p-0">
            <ul class="nav nav-tabs card-header-tabs" id="emailTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="compose-tab" data-bs-toggle="tab" data-bs-target="#compose" type="button" role="tab">
                        <i data-feather="edit-3" class="me-1"></i> Compose
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="templates-tab" data-bs-toggle="tab" data-bs-target="#templates" type="button" role="tab">
                        <i data-feather="file-text" class="me-1"></i> Templates
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab">
                        <i data-feather="clock" class="me-1"></i> History
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics" type="button" role="tab">
                        <i data-feather="bar-chart-2" class="me-1"></i> Analytics
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="queue-tab" data-bs-toggle="tab" data-bs-target="#queue" type="button" role="tab">
                        <i data-feather="layers" class="me-1"></i> Queue
                    </button>
                </li>
            </ul>
        </div>
    </div>

    <!-- Tab Content -->
    <div class="tab-content" id="emailTabsContent">
        <!-- Compose Tab -->
        <div class="tab-pane fade show active" id="compose" role="tabpanel">
            <div class="row">
                <div class="col-lg-8">
                    <div class="card mb-4">
                        <div class="card-header">
                            <i data-feather="send" class="me-2"></i>
                            Compose Email
                        </div>
                        <div class="card-body">
                            <!-- Template Selection -->
                            <div class="mb-3">
                                <label class="form-label">Email Template</label>
                                <select class="form-select" id="composeTemplate" onchange="onTemplateChange()">
                                    <option value="">Select a template...</option>
                                </select>
                            </div>

                            <!-- Custom Subject -->
                            <div class="mb-3">
                                <label class="form-label">Subject <span class="text-muted small">(optional override)</span></label>
                                <input type="text" class="form-control" id="composeSubject" placeholder="Leave blank to use template default">
                            </div>

                            <!-- Recipient Selection -->
                            <div class="mb-3">
                                <label class="form-label">Recipients</label>
                                <div class="btn-group w-100 mb-2" role="group">
                                    <input type="radio" class="btn-check" name="recipientMode" id="modeSearch" value="search" checked>
                                    <label class="btn btn-outline-primary" for="modeSearch">Search</label>

                                    <input type="radio" class="btn-check" name="recipientMode" id="modeFilter" value="filter">
                                    <label class="btn btn-outline-primary" for="modeFilter">By Filter</label>

                                    <input type="radio" class="btn-check" name="recipientMode" id="modeAll" value="all">
                                    <label class="btn btn-outline-primary" for="modeAll">All Confirmed</label>
                                </div>

                                <!-- Search Mode -->
                                <div id="searchModeDiv">
                                    <input type="text" class="form-control" id="recipientSearch"
                                           placeholder="Search by name or email..." onkeyup="searchRecipients()">
                                    <div id="searchResults" class="list-group mt-2" style="max-height: 200px; overflow-y: auto;"></div>
                                </div>

                                <!-- Filter Mode -->
                                <div id="filterModeDiv" style="display: none;">
                                    <div class="row g-2">
                                        <div class="col-md-6">
                                            <select class="form-select" id="filterConfirmed">
                                                <option value="">Any Confirmed Status</option>
                                                <option value="YES" selected>Confirmed</option>
                                                <option value="NO">Not Confirmed</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <select class="form-select" id="filterActive">
                                                <option value="">Any Status</option>
                                                <option value="true" selected>Active Only</option>
                                                <option value="false">Inactive Only</option>
                                            </select>
                                        </div>
                                    </div>
                                    <button class="btn btn-sm btn-outline-primary mt-2" onclick="loadFilteredRecipients()">
                                        <i data-feather="filter" class="me-1"></i> Load Recipients
                                    </button>
                                </div>

                                <!-- Selected Recipients -->
                                <div class="mt-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <strong>Selected: <span id="selectedRecipientCount" class="badge bg-primary">0</span></strong>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="clearSelectedRecipients()">Clear All</button>
                                    </div>
                                    <div id="selectedRecipientsList" class="d-flex flex-wrap gap-1"></div>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer">
                            <div class="d-flex justify-content-end">
                                <button class="btn btn-outline-secondary me-2" onclick="previewComposedEmail()">
                                    <i data-feather="eye" class="me-1"></i> Preview
                                </button>
                                <button class="btn btn-primary" onclick="sendComposedEmail()">
                                    <i data-feather="send" class="me-1"></i> Send Email
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Preview Panel -->
                <div class="col-lg-4">
                    <div class="card bg-light">
                        <div class="card-header">
                            <i data-feather="eye" class="me-2"></i>
                            Email Preview
                        </div>
                        <div class="card-body" id="emailPreviewPanel">
                            <p class="text-muted text-center">Select a template to preview</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Templates Tab -->
        <div class="tab-pane fade" id="templates" role="tabpanel">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <i data-feather="file-text" class="me-2"></i>
                        Email Templates
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-info me-2" onclick="openSendGridSyncModal()">
                            <i data-feather="download-cloud" class="me-1"></i> Sync from SendGrid
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="openCreateTemplateModal()">
                            <i data-feather="plus" class="me-1"></i> Create Template
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="templatesTable">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Display Name</th>
                                    <th>Description</th>
                                    <th>Status</th>
                                    <th>Type</th>
                                    <th width="180">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="templatesBody">
                                <tr>
                                    <td colspan="6" class="text-center py-4">
                                        <div class="spinner-border spinner-border-sm me-2"></div>
                                        Loading templates...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Tab -->
        <div class="tab-pane fade" id="history" role="tabpanel">
            <!-- Filters -->
            <div class="card mb-4">
                <div class="card-header">
                    <i data-feather="filter" class="me-2"></i>
                    Filters
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label small">Search</label>
                            <input type="text" class="form-control" id="historySearch" placeholder="Email, name...">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small">Template</label>
                            <select class="form-select" id="historyTemplate">
                                <option value="">All Templates</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small">Status</label>
                            <select class="form-select" id="historyStatus">
                                <option value="">All Statuses</option>
                                <option value="sent">Sent</option>
                                <option value="delivered">Delivered</option>
                                <option value="open">Opened</option>
                                <option value="click">Clicked</option>
                                <option value="bounce">Bounced</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small">Date Range</label>
                            <select class="form-select" id="historyDays">
                                <option value="7">Last 7 days</option>
                                <option value="30" selected>Last 30 days</option>
                                <option value="90">Last 90 days</option>
                                <option value="365">Last year</option>
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button class="btn btn-primary me-2" onclick="loadEmailHistory(1)">
                                <i data-feather="search" class="me-1"></i> Search
                            </button>
                            <button class="btn btn-outline-secondary" onclick="clearHistoryFilters()">
                                <i data-feather="x" class="me-1"></i> Clear
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- History Table -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <i data-feather="clock" class="me-2"></i>
                        Email History
                    </div>
                    <div class="small text-muted">
                        Showing <span id="historyShowingCount">0</span> of <span id="historyTotalCount">0</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Recipient</th>
                                    <th>Template</th>
                                    <th>Subject</th>
                                    <th>Status</th>
                                    <th>Sent At</th>
                                    <th>Last Activity</th>
                                </tr>
                            </thead>
                            <tbody id="historyBody">
                                <tr>
                                    <td colspan="6" class="text-center py-4">
                                        <div class="spinner-border spinner-border-sm me-2"></div>
                                        Loading history...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <select class="form-select form-select-sm" id="historyPageSize" onchange="loadEmailHistory(1)" style="width: auto;">
                            <option value="25">25 per page</option>
                            <option value="50" selected>50 per page</option>
                            <option value="100">100 per page</option>
                        </select>
                        <nav>
                            <ul class="pagination pagination-sm mb-0" id="historyPagination"></ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div class="tab-pane fade" id="analytics" role="tabpanel">
            <!-- Stats Cards -->
            <div class="row mb-4">
                <div class="col-xl-2 col-md-4 col-6 mb-4">
                    <div class="card bg-primary text-white h-100 stats-card">
                        <div class="card-body py-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="text-white-75 small">Total Sent</div>
                                    <div class="text-lg fw-bold" id="statSent">-</div>
                                </div>
                                <i data-feather="send" class="feather-xl text-white-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-2 col-md-4 col-6 mb-4">
                    <div class="card bg-success text-white h-100 stats-card">
                        <div class="card-body py-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="text-white-75 small">Delivered</div>
                                    <div class="text-lg fw-bold" id="statDelivered">-</div>
                                </div>
                                <i data-feather="check-circle" class="feather-xl text-white-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-2 col-md-4 col-6 mb-4">
                    <div class="card bg-info text-white h-100 stats-card">
                        <div class="card-body py-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="text-white-75 small">Opened</div>
                                    <div class="text-lg fw-bold" id="statOpened">-</div>
                                </div>
                                <i data-feather="mail" class="feather-xl text-white-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-2 col-md-4 col-6 mb-4">
                    <div class="card bg-warning text-white h-100 stats-card">
                        <div class="card-body py-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="text-white-75 small">Clicked</div>
                                    <div class="text-lg fw-bold" id="statClicked">-</div>
                                </div>
                                <i data-feather="mouse-pointer" class="feather-xl text-white-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-2 col-md-4 col-6 mb-4">
                    <div class="card bg-danger text-white h-100 stats-card">
                        <div class="card-body py-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="text-white-75 small">Bounced</div>
                                    <div class="text-lg fw-bold" id="statBounced">-</div>
                                </div>
                                <i data-feather="alert-triangle" class="feather-xl text-white-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-2 col-md-4 col-6 mb-4">
                    <div class="card bg-secondary text-white h-100 stats-card">
                        <div class="card-body py-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="text-white-75 small">Spam Reports</div>
                                    <div class="text-lg fw-bold" id="statSpam">-</div>
                                </div>
                                <i data-feather="slash" class="feather-xl text-white-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rate Cards -->
            <div class="row mb-4">
                <div class="col-md-3 mb-4">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <div class="small text-muted mb-1">Delivery Rate</div>
                            <div class="h2 mb-0" id="rateDelivery">-</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-4">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <div class="small text-muted mb-1">Open Rate</div>
                            <div class="h2 mb-0" id="rateOpen">-</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-4">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <div class="small text-muted mb-1">Click Rate</div>
                            <div class="h2 mb-0" id="rateClick">-</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-4">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <div class="small text-muted mb-1">Bounce Rate</div>
                            <div class="h2 mb-0" id="rateBounce">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="row mb-4">
                <div class="col-xl-8 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <i data-feather="trending-up" class="me-2"></i>
                            Email Activity (Last 30 Days)
                        </div>
                        <div class="card-body">
                            <canvas id="dailyTrendChart" height="300"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-xl-4 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <i data-feather="pie-chart" class="me-2"></i>
                            Delivery Funnel
                        </div>
                        <div class="card-body d-flex align-items-center justify-content-center">
                            <canvas id="deliveryFunnelChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Template Stats -->
            <div class="card">
                <div class="card-header">
                    <i data-feather="layers" class="me-2"></i>
                    Performance by Template
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Template</th>
                                    <th>Sent</th>
                                    <th>Delivered</th>
                                    <th>Opened</th>
                                    <th>Clicked</th>
                                    <th>Bounced</th>
                                    <th>Open Rate</th>
                                    <th>Click Rate</th>
                                </tr>
                            </thead>
                            <tbody id="templateStatsBody">
                                <tr>
                                    <td colspan="8" class="text-center py-4">
                                        <div class="spinner-border spinner-border-sm me-2"></div>
                                        Loading stats...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Queue Tab -->
        <div class="tab-pane fade" id="queue" role="tabpanel">
            <!-- Queue Stats -->
            <div class="row mb-4">
                <div class="col-md-3 col-6 mb-3">
                    <div class="card bg-warning text-white h-100">
                        <div class="card-body py-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="text-white-75 small">Pending</div>
                                    <div class="text-lg fw-bold" id="queueStatPending">-</div>
                                </div>
                                <i data-feather="clock" class="feather-xl text-white-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-6 mb-3">
                    <div class="card bg-info text-white h-100">
                        <div class="card-body py-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="text-white-75 small">Processing</div>
                                    <div class="text-lg fw-bold" id="queueStatProcessing">-</div>
                                </div>
                                <i data-feather="refresh-cw" class="feather-xl text-white-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-6 mb-3">
                    <div class="card bg-success text-white h-100">
                        <div class="card-body py-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="text-white-75 small">Sent</div>
                                    <div class="text-lg fw-bold" id="queueStatSent">-</div>
                                </div>
                                <i data-feather="check-circle" class="feather-xl text-white-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-6 mb-3">
                    <div class="card bg-danger text-white h-100">
                        <div class="card-body py-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="text-white-75 small">Failed</div>
                                    <div class="text-lg fw-bold" id="queueStatFailed">-</div>
                                </div>
                                <i data-feather="alert-triangle" class="feather-xl text-white-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Scheduler Status -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <i data-feather="clock" class="me-2"></i>
                    Automated Batch Processing Schedule
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3 mb-md-0">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <div class="bg-primary bg-opacity-10 rounded-circle p-3">
                                        <i data-feather="calendar" class="text-primary"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <div class="small text-muted mb-1">Next Batch Processor Run</div>
                                    <div class="fw-bold" id="nextBatchRun">Loading...</div>
                                    <div class="small text-muted" id="nextBatchCountdown"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <div class="bg-info bg-opacity-10 rounded-circle p-3">
                                        <i data-feather="repeat" class="text-info"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <div class="small text-muted mb-1">Schedule</div>
                                    <div class="fw-bold">Every 15 minutes</div>
                                    <div class="small text-muted">50 emails per batch</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">Manual Processing</h6>
                            <p class="text-muted small mb-0">Process the queue immediately without waiting for the scheduled batch</p>
                        </div>
                        <button class="btn btn-primary" onclick="triggerManualBatch()" id="manualBatchBtn">
                            <i data-feather="play" class="me-1"></i> Process Batch Now
                        </button>
                    </div>
                </div>
            </div>

            <!-- Email Queue Table -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <i data-feather="layers" class="me-2"></i>
                        Email Queue
                    </div>
                    <button class="btn btn-sm btn-outline-primary" onclick="loadEmailQueue()" title="Refresh queue">
                        <i data-feather="refresh-cw" class="feather-sm"></i>
                        Refresh
                    </button>
                </div>
                <div class="card-body">
                    <!-- Pending Emails Section -->
                    <div class="mb-4">
                        <h6 class="mb-3">
                            <span class="badge bg-warning text-dark me-2">Pending</span>
                            <span class="text-muted small" id="pendingCount">-</span>
                        </h6>
                        <div class="table-responsive">
                            <table class="table table-hover table-sm">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Recipient</th>
                                        <th>Template</th>
                                        <th>Priority</th>
                                        <th>Attempts</th>
                                        <th>Created</th>
                                        <th>Scheduled</th>
                                        <th>Batch ID</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="pendingQueueBody">
                                    <tr>
                                        <td colspan="9" class="text-center py-4">
                                            <div class="spinner-border spinner-border-sm me-2"></div>
                                            Loading pending emails...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Recent Non-Pending Emails Section -->
                    <div>
                        <h6 class="mb-3">
                            <span class="badge bg-secondary me-2">Recent Activity</span>
                            <span class="text-muted small">Created/Updated within past hour</span>
                            <span class="text-muted small ms-2" id="recentCount">-</span>
                        </h6>
                        <div class="table-responsive">
                            <table class="table table-hover table-sm">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Recipient</th>
                                        <th>Template</th>
                                        <th>Priority</th>
                                        <th>Status</th>
                                        <th>Attempts</th>
                                        <th>Created</th>
                                        <th>Completed</th>
                                        <th>Batch ID</th>
                                    </tr>
                                </thead>
                                <tbody id="recentQueueBody">
                                    <tr>
                                        <td colspan="9" class="text-center py-4">
                                            <div class="spinner-border spinner-border-sm me-2"></div>
                                            Loading recent activity...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Batch Logs -->
            <div class="card">
                <div class="card-header">
                    <i data-feather="list" class="me-2"></i>
                    Recent Batch Logs
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead>
                                <tr>
                                    <th>Batch ID</th>
                                    <th>Started</th>
                                    <th>Completed</th>
                                    <th>Duration</th>
                                    <th>Processed</th>
                                    <th>Sent</th>
                                    <th>Failed</th>
                                    <th>Worker</th>
                                </tr>
                            </thead>
                            <tbody id="batchLogsBody">
                                <tr>
                                    <td colspan="8" class="text-center py-4">
                                        <div class="spinner-border spinner-border-sm me-2"></div>
                                        Loading batch logs...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Template Editor Modal -->
<div class="modal fade" id="templateModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="templateModalTitle">Create Template</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="templateId">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Name (identifier)</label>
                            <input type="text" class="form-control" id="templateName" placeholder="e.g., welcome_email">
                            <div class="form-text">Unique identifier, lowercase with underscores</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Display Name</label>
                            <input type="text" class="form-control" id="templateDisplayName" placeholder="e.g., Welcome Email">
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <input type="text" class="form-control" id="templateDescription" placeholder="Brief description of this template">
                </div>
                <div class="mb-3">
                    <label class="form-label">SendGrid Template ID <span class="badge bg-info-soft text-info">Optional</span></label>
                    <input type="text" class="form-control" id="templateSendgridId" placeholder="e.g., d-1234567890abcdef">
                    <div class="form-text">
                        If set, SendGrid's dynamic template will be used (ignores HTML/Text content below).
                        Leave empty to use local template rendering.
                        <a href="https://mc.sendgrid.com/dynamic-templates" target="_blank" class="text-primary">Create templates in SendGrid</a>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Subject</label>
                    <input type="text" class="form-control" id="templateSubject" placeholder="Email subject line">
                    <div class="form-text">For local templates only (ignored if SendGrid template ID is set)</div>
                </div>
                <div class="mb-3">
                    <label class="form-label">HTML Content</label>
                    <textarea class="form-control" id="templateHtmlContent" rows="12" style="font-family: monospace;"></textarea>
                    <div class="form-text">Available variables: {first_name}, {last_name}, {email}, {event_name}, {login_url}, {confirm_url}, etc.</div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Plain Text Content</label>
                    <textarea class="form-control" id="templateTextContent" rows="6" style="font-family: monospace;"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveTemplate()">
                    <i data-feather="save" class="me-1"></i> Save Template
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Email Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <strong>Subject:</strong> <span id="previewSubject"></span>
                </div>
                <hr>
                <iframe id="previewIframe" sandbox="allow-same-origin" style="width: 100%; height: 400px; border: 1px solid #ddd; background: #fff;"></iframe>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Test Email Modal -->
<div class="modal fade" id="testEmailModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i data-feather="zap" class="me-2"></i>
                    Send Test Email
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted small mb-3">
                    Send a test email to verify your SendGrid configuration is working correctly.
                </p>
                <div class="mb-3">
                    <label class="form-label">Recipient Email Address</label>
                    <input type="email" class="form-control" id="testEmailAddress" placeholder="your@email.com">
                    <div class="form-text">The test email will be sent to this address.</div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Template (optional)</label>
                    <select class="form-select" id="testEmailTemplate">
                        <option value="">Simple Test Email</option>
                    </select>
                    <div class="form-text">Optionally test with a specific template to verify rendering.</div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Custom Subject (optional)</label>
                    <input type="text" class="form-control" id="testEmailSubject" placeholder="Leave blank to use default">
                </div>

                <!-- Test Result -->
                <div id="testEmailResult" style="display: none;">
                    <hr>
                    <div id="testEmailResultContent"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="sendTestEmail()" id="sendTestEmailBtn">
                    <i data-feather="send" class="me-1"></i> Send Test
                </button>
            </div>
        </div>
    </div>
</div>

<!-- SendGrid Sync Modal -->
<div class="modal fade" id="sendGridSyncModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i data-feather="download-cloud" class="me-2"></i>
                    Import Templates from SendGrid
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted small mb-3">
                    Import dynamic templates from your connected SendGrid account. Templates will be copied to your local database for customization.
                </p>

                <!-- Loading State -->
                <div id="sgSyncLoading" class="text-center py-4">
                    <div class="spinner-border spinner-border-sm me-2"></div>
                    Loading templates from SendGrid...
                </div>

                <!-- Error State -->
                <div id="sgSyncError" style="display: none;">
                    <div class="alert alert-danger mb-0">
                        <i data-feather="alert-circle" class="me-2"></i>
                        <span id="sgSyncErrorMessage"></span>
                    </div>
                </div>

                <!-- Templates List -->
                <div id="sgSyncContent" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="text-muted small">
                            <span id="sgTemplateCount">0</span> templates found
                        </span>
                        <button class="btn btn-sm btn-outline-primary" onclick="syncAllSendGridTemplates()">
                            <i data-feather="download" class="me-1"></i> Import All
                        </button>
                    </div>
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-sm table-hover">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>Template Name</th>
                                    <th>Active Version</th>
                                    <th>Updated</th>
                                    <th width="100">Action</th>
                                </tr>
                            </thead>
                            <tbody id="sgTemplatesBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Import Result -->
                <div id="sgSyncResult" style="display: none;">
                    <hr>
                    <div id="sgSyncResultContent"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
// =============================================================================
// State
// =============================================================================
let templates = [];
let selectedRecipients = new Map(); // id -> {id, name, email}
let historyCurrentPage = 1;
let dailyChart = null;
let funnelChart = null;

// =============================================================================
// Initialization
// =============================================================================
document.addEventListener('DOMContentLoaded', () => {
    loadTemplates();
    setupRecipientModeListeners();

    // Load tab content when switching
    document.querySelectorAll('#emailTabs button').forEach(tab => {
        tab.addEventListener('shown.bs.tab', (e) => {
            const target = e.target.getAttribute('data-bs-target');
            if (target === '#analytics') loadAnalytics();
            if (target === '#history') loadEmailHistory(1);
            if (target === '#templates') loadTemplates();
            if (target === '#queue') loadQueueTab();
        });

        // Clean up scheduler interval when leaving queue tab
        tab.addEventListener('hide.bs.tab', (e) => {
            const target = e.target.getAttribute('data-bs-target');
            if (target === '#queue') {
                if (schedulerStatusInterval) {
                    clearInterval(schedulerStatusInterval);
                    schedulerStatusInterval = null;
                }
                if (countdownInterval) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                }
            }
        });
    });

    // Refresh icons
    feather.replace();
});

function setupRecipientModeListeners() {
    document.querySelectorAll('input[name="recipientMode"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            document.getElementById('searchModeDiv').style.display = e.target.value === 'search' ? 'block' : 'none';
            document.getElementById('filterModeDiv').style.display = e.target.value === 'filter' ? 'block' : 'none';

            if (e.target.value === 'all') {
                loadAllConfirmedRecipients();
            }
        });
    });
}

// =============================================================================
// Template Functions
// =============================================================================
async function loadTemplates() {
    try {
        const response = await csrfFetch('/api/email/templates?active_only=false');
        if (!response.ok) throw new Error('Failed to load templates');

        templates = await response.json();
        renderTemplatesTable();
        populateTemplateSelects();
    } catch (error) {
        console.error('Error loading templates:', error);
    }
}

function renderTemplatesTable() {
    const tbody = document.getElementById('templatesBody');

    if (templates.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-muted">No templates found.</td></tr>';
        return;
    }

    tbody.innerHTML = templates.map(t => `
        <tr>
            <td><code>${t.name}</code></td>
            <td>${t.display_name}</td>
            <td class="small text-muted">${t.description || '-'}</td>
            <td>
                ${t.is_active
                    ? '<span class="badge bg-success">Active</span>'
                    : '<span class="badge bg-secondary">Inactive</span>'}
            </td>
            <td>
                ${t.is_system
                    ? '<span class="badge bg-info">System</span>'
                    : '<span class="badge bg-secondary">Custom</span>'}
                ${t.sendgrid_template_id
                    ? '<span class="badge bg-primary ms-1" title="Uses SendGrid dynamic template">SendGrid</span>'
                    : ''}
            </td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="previewTemplate(${t.id})" title="Preview">
                        <i data-feather="eye"></i>
                    </button>
                    <button class="btn btn-outline-secondary" onclick="editTemplate(${t.id})" title="Edit">
                        <i data-feather="edit-2"></i>
                    </button>
                    <button class="btn btn-outline-info" onclick="duplicateTemplate(${t.id})" title="Duplicate">
                        <i data-feather="copy"></i>
                    </button>
                    ${!t.is_system ? `
                        <button class="btn btn-outline-danger" onclick="deleteTemplate(${t.id})" title="Delete">
                            <i data-feather="trash-2"></i>
                        </button>
                    ` : ''}
                </div>
            </td>
        </tr>
    `).join('');

    feather.replace();
}

function populateTemplateSelects() {
    const composeSelect = document.getElementById('composeTemplate');
    const historySelect = document.getElementById('historyTemplate');

    const options = templates.filter(t => t.is_active).map(t =>
        `<option value="${t.id}">${t.display_name}</option>`
    ).join('');

    composeSelect.innerHTML = '<option value="">Select a template...</option>' + options;
    historySelect.innerHTML = '<option value="">All Templates</option>' +
        templates.map(t => `<option value="${t.name}">${t.display_name}</option>`).join('');
}

function openCreateTemplateModal() {
    document.getElementById('templateModalTitle').textContent = 'Create Template';
    document.getElementById('templateId').value = '';
    document.getElementById('templateName').value = '';
    document.getElementById('templateName').disabled = false;
    document.getElementById('templateDisplayName').value = '';
    document.getElementById('templateDescription').value = '';
    document.getElementById('templateSendgridId').value = '';
    document.getElementById('templateSubject').value = '';
    document.getElementById('templateHtmlContent').value = '';
    document.getElementById('templateTextContent').value = '';

    new bootstrap.Modal(document.getElementById('templateModal')).show();
    feather.replace();
}

async function editTemplate(id) {
    try {
        const response = await csrfFetch(`/api/email/templates/${id}`);
        if (!response.ok) throw new Error('Failed to load template');

        const template = await response.json();

        document.getElementById('templateModalTitle').textContent = 'Edit Template';
        document.getElementById('templateId').value = template.id;
        document.getElementById('templateName').value = template.name;
        document.getElementById('templateName').disabled = true;
        document.getElementById('templateDisplayName').value = template.display_name;
        document.getElementById('templateDescription').value = template.description || '';
        document.getElementById('templateSendgridId').value = template.sendgrid_template_id || '';
        document.getElementById('templateSubject').value = template.subject;
        document.getElementById('templateHtmlContent').value = template.html_content;
        document.getElementById('templateTextContent').value = template.text_content || '';

        new bootstrap.Modal(document.getElementById('templateModal')).show();
        feather.replace();
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to load template');
    }
}

async function saveTemplate() {
    const id = document.getElementById('templateId').value;
    const sendgridId = document.getElementById('templateSendgridId').value.trim();
    const data = {
        name: document.getElementById('templateName').value,
        display_name: document.getElementById('templateDisplayName').value,
        description: document.getElementById('templateDescription').value || null,
        sendgrid_template_id: sendgridId || null,
        subject: document.getElementById('templateSubject').value,
        html_content: document.getElementById('templateHtmlContent').value,
        text_content: document.getElementById('templateTextContent').value || null,
        available_variables: ['first_name', 'last_name', 'email', 'event_name', 'login_url', 'confirm_url']
    };

    try {
        const url = id ? `/api/email/templates/${id}` : '/api/email/templates';
        const method = id ? 'PUT' : 'POST';

        const response = await csrfFetch(url, {
            method,
            body: data
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to save template');
        }

        bootstrap.Modal.getInstance(document.getElementById('templateModal')).hide();
        loadTemplates();
        alert('Template saved successfully');
    } catch (error) {
        console.error('Error:', error);
        alert(error.message);
    }
}

async function deleteTemplate(id) {
    if (!confirm('Are you sure you want to delete this template?')) return;

    try {
        const response = await csrfFetch(`/api/email/templates/${id}`, {
            method: 'DELETE'
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to delete template');
        }

        loadTemplates();
    } catch (error) {
        console.error('Error:', error);
        alert(error.message);
    }
}

async function duplicateTemplate(id) {
    const newName = prompt('Enter name for the new template:', '');
    if (!newName) return;

    try {
        const response = await csrfFetch(`/api/email/templates/${id}/duplicate?new_name=${encodeURIComponent(newName)}`, {
            method: 'POST'
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to duplicate template');
        }

        loadTemplates();
        alert('Template duplicated successfully');
    } catch (error) {
        console.error('Error:', error);
        alert(error.message);
    }
}

async function previewTemplate(id) {
    try {
        const response = await csrfFetch(`/api/email/templates/${id}/preview`, {
            method: 'POST',
            body: { sample_data: {} }
        });

        if (!response.ok) throw new Error('Failed to preview template');

        const preview = await response.json();
        document.getElementById('previewSubject').textContent = preview.subject;

        // Use iframe to sandbox the email CSS
        const iframe = document.getElementById('previewIframe');
        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
        iframeDoc.open();
        iframeDoc.write(preview.html_content);
        iframeDoc.close();

        new bootstrap.Modal(document.getElementById('previewModal')).show();
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to preview template');
    }
}

// =============================================================================
// Compose Functions
// =============================================================================
async function onTemplateChange() {
    const templateId = document.getElementById('composeTemplate').value;
    const previewPanel = document.getElementById('emailPreviewPanel');

    if (!templateId) {
        previewPanel.innerHTML = '<p class="text-muted text-center">Select a template to preview</p>';
        return;
    }

    try {
        const response = await csrfFetch(`/api/email/templates/${templateId}/preview`, {
            method: 'POST',
            body: { sample_data: {} }
        });

        if (!response.ok) throw new Error('Failed to preview');

        const preview = await response.json();

        // Use iframe to sandbox the email CSS
        previewPanel.innerHTML = `
            <div class="small text-muted mb-2"><strong>Subject:</strong> ${escapeHtml(preview.subject)}</div>
            <iframe id="composePreviewIframe" sandbox="allow-same-origin" style="width: 100%; height: 350px; border: 1px solid #ddd; background: #fff;"></iframe>
        `;

        // Write content to iframe after it's in the DOM
        setTimeout(() => {
            const iframe = document.getElementById('composePreviewIframe');
            if (iframe) {
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                iframeDoc.open();
                iframeDoc.write(preview.html_content);
                iframeDoc.close();
            }
        }, 0);
    } catch (error) {
        console.error('Error:', error);
        previewPanel.innerHTML = '<p class="text-danger text-center">Failed to load preview</p>';
    }
}

let searchTimeout = null;
async function searchRecipients() {
    clearTimeout(searchTimeout);
    const query = document.getElementById('recipientSearch').value.trim();

    if (query.length < 2) {
        document.getElementById('searchResults').innerHTML = '';
        return;
    }

    searchTimeout = setTimeout(async () => {
        try {
            const response = await csrfFetch(`/api/admin/participants?search=${encodeURIComponent(query)}&page_size=10`);
            if (!response.ok) throw new Error('Search failed');

            const data = await response.json();
            const resultsDiv = document.getElementById('searchResults');

            if (data.items.length === 0) {
                resultsDiv.innerHTML = '<div class="list-group-item text-muted">No results found</div>';
                return;
            }

            resultsDiv.innerHTML = data.items.map(p => `
                <button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                        onclick="addRecipient(${p.id}, '${p.first_name} ${p.last_name}', '${p.email}')">
                    <span>${p.first_name} ${p.last_name}</span>
                    <small class="text-muted">${p.email}</small>
                </button>
            `).join('');
        } catch (error) {
            console.error('Error:', error);
        }
    }, 300);
}

async function loadFilteredRecipients() {
    const confirmed = document.getElementById('filterConfirmed').value;
    const active = document.getElementById('filterActive').value;

    let url = '/api/admin/participants?page_size=500';
    if (confirmed) url += `&confirmed=${confirmed}`;
    if (active) url += `&is_active=${active}`;

    try {
        const response = await csrfFetch(url);
        if (!response.ok) throw new Error('Failed to load');

        const data = await response.json();
        selectedRecipients.clear();

        data.items.forEach(p => {
            selectedRecipients.set(p.id, { id: p.id, name: `${p.first_name} ${p.last_name}`, email: p.email });
        });

        updateSelectedRecipientsUI();
        alert(`Loaded ${data.items.length} recipients`);
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to load recipients');
    }
}

async function loadAllConfirmedRecipients() {
    try {
        const response = await csrfFetch('/api/admin/participants?confirmed=YES&is_active=true&page_size=500');
        if (!response.ok) throw new Error('Failed to load');

        const data = await response.json();
        selectedRecipients.clear();

        data.items.forEach(p => {
            selectedRecipients.set(p.id, { id: p.id, name: `${p.first_name} ${p.last_name}`, email: p.email });
        });

        updateSelectedRecipientsUI();
    } catch (error) {
        console.error('Error:', error);
    }
}

function addRecipient(id, name, email) {
    selectedRecipients.set(id, { id, name, email });
    updateSelectedRecipientsUI();
    document.getElementById('recipientSearch').value = '';
    document.getElementById('searchResults').innerHTML = '';
}

function removeRecipient(id) {
    selectedRecipients.delete(id);
    updateSelectedRecipientsUI();
}

function clearSelectedRecipients() {
    selectedRecipients.clear();
    updateSelectedRecipientsUI();
}

function updateSelectedRecipientsUI() {
    document.getElementById('selectedRecipientCount').textContent = selectedRecipients.size;

    const listDiv = document.getElementById('selectedRecipientsList');
    if (selectedRecipients.size === 0) {
        listDiv.innerHTML = '<span class="text-muted small">No recipients selected</span>';
        return;
    }

    if (selectedRecipients.size > 20) {
        listDiv.innerHTML = `<span class="badge bg-primary">${selectedRecipients.size} recipients selected</span>`;
        return;
    }

    listDiv.innerHTML = Array.from(selectedRecipients.values()).map(r => `
        <span class="badge bg-light text-dark border">
            ${r.name}
            <button type="button" class="btn-close btn-close-sm ms-1" onclick="removeRecipient(${r.id})" style="font-size: 0.5rem;"></button>
        </span>
    `).join('');
}

function previewComposedEmail() {
    const templateId = document.getElementById('composeTemplate').value;
    if (!templateId) {
        alert('Please select a template');
        return;
    }
    previewTemplate(parseInt(templateId));
}

async function sendComposedEmail() {
    const templateId = document.getElementById('composeTemplate').value;
    const customSubject = document.getElementById('composeSubject').value.trim() || null;

    if (!templateId) {
        alert('Please select a template');
        return;
    }

    if (selectedRecipients.size === 0) {
        alert('Please select at least one recipient');
        return;
    }

    if (!confirm(`Send email to ${selectedRecipients.size} recipient(s)?`)) return;

    try {
        const response = await csrfFetch('/api/email/bulk', {
            method: 'POST',
            body: {
                participant_ids: Array.from(selectedRecipients.keys()),
                template_id: parseInt(templateId),
                custom_subject: customSubject,
                custom_variables: {}
            }
        });

        const data = await response.json();
        alert(data.message);

        if (data.success) {
            clearSelectedRecipients();
            document.getElementById('composeTemplate').value = '';
            document.getElementById('composeSubject').value = '';
            document.getElementById('emailPreviewPanel').innerHTML = '<p class="text-muted text-center">Select a template to preview</p>';
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to send emails');
    }
}

// =============================================================================
// History Functions
// =============================================================================
async function loadEmailHistory(page = 1) {
    historyCurrentPage = page;

    const search = document.getElementById('historySearch').value.trim() || null;
    const templateName = document.getElementById('historyTemplate').value || null;
    const status = document.getElementById('historyStatus').value || null;
    const days = document.getElementById('historyDays').value;
    const pageSize = document.getElementById('historyPageSize').value;

    let url = `/api/email/history?page=${page}&page_size=${pageSize}&days=${days}`;
    if (search) url += `&search=${encodeURIComponent(search)}`;
    if (templateName) url += `&template_name=${encodeURIComponent(templateName)}`;
    if (status) url += `&status=${encodeURIComponent(status)}`;

    try {
        const response = await csrfFetch(url);
        if (!response.ok) throw new Error('Failed to load history');

        const data = await response.json();
        renderHistoryTable(data.items);
        renderHistoryPagination(data.page, data.total_pages);
        document.getElementById('historyShowingCount').textContent = data.items.length;
        document.getElementById('historyTotalCount').textContent = data.total;
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('historyBody').innerHTML =
            '<tr><td colspan="6" class="text-center text-danger py-4">Failed to load history</td></tr>';
    }
}

function renderHistoryTable(items) {
    const tbody = document.getElementById('historyBody');

    if (items.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-muted">No emails found</td></tr>';
        return;
    }

    tbody.innerHTML = items.map(item => {
        const statusBadge = getStatusBadge(item.status);
        const sentAt = formatDateTime(item.sent_at);
        const lastEvent = item.last_event_at ? formatDateTime(item.last_event_at) : '-';

        return `
            <tr>
                <td>
                    <div>${item.recipient_name || '-'}</div>
                    <small class="text-muted">${item.recipient_email}</small>
                </td>
                <td><code class="small">${item.template_name || '-'}</code></td>
                <td class="small">${item.subject || '-'}</td>
                <td>${statusBadge}</td>
                <td class="small">${sentAt}</td>
                <td class="small">${lastEvent}</td>
            </tr>
        `;
    }).join('');
}

function getStatusBadge(status) {
    const badges = {
        'sent': '<span class="badge bg-secondary">Sent</span>',
        'delivered': '<span class="badge bg-success">Delivered</span>',
        'open': '<span class="badge bg-info">Opened</span>',
        'click': '<span class="badge bg-primary">Clicked</span>',
        'bounce': '<span class="badge bg-danger">Bounced</span>',
        'dropped': '<span class="badge bg-danger">Dropped</span>',
        'spamreport': '<span class="badge bg-warning">Spam</span>',
        'failed': '<span class="badge bg-danger">Failed</span>'
    };
    return badges[status] || `<span class="badge bg-secondary">${status}</span>`;
}

function renderHistoryPagination(currentPage, totalPages) {
    const pagination = document.getElementById('historyPagination');

    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }

    let html = `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="loadEmailHistory(${currentPage - 1}); return false;">
                <i data-feather="chevron-left"></i>
            </a>
        </li>
    `;

    const maxPages = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxPages / 2));
    let endPage = Math.min(totalPages, startPage + maxPages - 1);

    for (let i = startPage; i <= endPage; i++) {
        html += `
            <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="loadEmailHistory(${i}); return false;">${i}</a>
            </li>
        `;
    }

    html += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="loadEmailHistory(${currentPage + 1}); return false;">
                <i data-feather="chevron-right"></i>
            </a>
        </li>
    `;

    pagination.innerHTML = html;
    feather.replace();
}

function clearHistoryFilters() {
    document.getElementById('historySearch').value = '';
    document.getElementById('historyTemplate').value = '';
    document.getElementById('historyStatus').value = '';
    document.getElementById('historyDays').value = '30';
    loadEmailHistory(1);
}

// =============================================================================
// Analytics Functions
// =============================================================================
async function loadAnalytics() {
    await Promise.all([
        loadAnalyticsStats(),
        loadDailyStats(),
        loadTemplateStats()
    ]);
}

async function loadAnalyticsStats() {
    try {
        const response = await csrfFetch('/api/email/analytics');
        if (!response.ok) throw new Error('Failed to load analytics');

        const data = await response.json();

        document.getElementById('statSent').textContent = data.total_sent.toLocaleString();
        document.getElementById('statDelivered').textContent = data.total_delivered.toLocaleString();
        document.getElementById('statOpened').textContent = data.total_opened.toLocaleString();
        document.getElementById('statClicked').textContent = data.total_clicked.toLocaleString();
        document.getElementById('statBounced').textContent = data.total_bounced.toLocaleString();
        document.getElementById('statSpam').textContent = data.total_spam_reports.toLocaleString();

        document.getElementById('rateDelivery').textContent = data.delivery_rate + '%';
        document.getElementById('rateOpen').textContent = data.open_rate + '%';
        document.getElementById('rateClick').textContent = data.click_rate + '%';
        document.getElementById('rateBounce').textContent = data.bounce_rate + '%';

        // Update funnel chart
        renderFunnelChart(data);
    } catch (error) {
        console.error('Error:', error);
    }
}

async function loadDailyStats() {
    try {
        const response = await csrfFetch('/api/email/analytics/daily?days=30');
        if (!response.ok) throw new Error('Failed to load daily stats');

        const data = await response.json();
        renderDailyChart(data.stats);
    } catch (error) {
        console.error('Error:', error);
    }
}

async function loadTemplateStats() {
    try {
        const response = await csrfFetch('/api/email/analytics/by-template');
        if (!response.ok) throw new Error('Failed to load template stats');

        const data = await response.json();
        renderTemplateStatsTable(data.templates);
    } catch (error) {
        console.error('Error:', error);
    }
}

function renderDailyChart(stats) {
    const ctx = document.getElementById('dailyTrendChart').getContext('2d');

    if (dailyChart) dailyChart.destroy();

    dailyChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: stats.map(s => s.date),
            datasets: [
                {
                    label: 'Sent',
                    data: stats.map(s => s.sent),
                    borderColor: '#0061f2',
                    backgroundColor: 'rgba(0, 97, 242, 0.1)',
                    tension: 0.3
                },
                {
                    label: 'Delivered',
                    data: stats.map(s => s.delivered),
                    borderColor: '#00ac69',
                    backgroundColor: 'rgba(0, 172, 105, 0.1)',
                    tension: 0.3
                },
                {
                    label: 'Opened',
                    data: stats.map(s => s.opened),
                    borderColor: '#00cfd5',
                    backgroundColor: 'rgba(0, 207, 213, 0.1)',
                    tension: 0.3
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function renderFunnelChart(data) {
    const ctx = document.getElementById('deliveryFunnelChart').getContext('2d');

    if (funnelChart) funnelChart.destroy();

    funnelChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Delivered', 'Opened', 'Clicked', 'Bounced'],
            datasets: [{
                data: [
                    data.total_delivered - data.total_opened,
                    data.total_opened - data.total_clicked,
                    data.total_clicked,
                    data.total_bounced
                ],
                backgroundColor: ['#00ac69', '#00cfd5', '#0061f2', '#e81500']
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function renderTemplateStatsTable(stats) {
    const tbody = document.getElementById('templateStatsBody');

    if (stats.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-muted">No statistics available</td></tr>';
        return;
    }

    tbody.innerHTML = stats.map(s => `
        <tr>
            <td>${s.display_name}</td>
            <td>${s.sent.toLocaleString()}</td>
            <td>${s.delivered.toLocaleString()}</td>
            <td>${s.opened.toLocaleString()}</td>
            <td>${s.clicked.toLocaleString()}</td>
            <td>${s.bounced.toLocaleString()}</td>
            <td><span class="badge bg-info">${s.open_rate}%</span></td>
            <td><span class="badge bg-primary">${s.click_rate}%</span></td>
        </tr>
    `).join('');
}

// =============================================================================
// Test Email Functions
// =============================================================================
function openTestEmailModal() {
    // Populate template dropdown
    const testTemplateSelect = document.getElementById('testEmailTemplate');
    testTemplateSelect.innerHTML = '<option value="">Simple Test Email</option>' +
        templates.filter(t => t.is_active).map(t =>
            `<option value="${t.id}">${t.display_name}</option>`
        ).join('');

    // Reset form
    document.getElementById('testEmailAddress').value = '';
    document.getElementById('testEmailSubject').value = '';
    document.getElementById('testEmailResult').style.display = 'none';
    document.getElementById('sendTestEmailBtn').disabled = false;

    new bootstrap.Modal(document.getElementById('testEmailModal')).show();
    feather.replace();
}

async function sendTestEmail() {
    const toEmail = document.getElementById('testEmailAddress').value.trim();
    const templateId = document.getElementById('testEmailTemplate').value || null;
    const subject = document.getElementById('testEmailSubject').value.trim() || null;

    if (!toEmail) {
        alert('Please enter a recipient email address');
        return;
    }

    // Validate email format
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(toEmail)) {
        alert('Please enter a valid email address');
        return;
    }

    const btn = document.getElementById('sendTestEmailBtn');
    const resultDiv = document.getElementById('testEmailResult');
    const resultContent = document.getElementById('testEmailResultContent');

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Sending...';

    try {
        const response = await csrfFetch('/api/email/test', {
            method: 'POST',
            body: {
                to_email: toEmail,
                template_id: templateId ? parseInt(templateId) : null,
                subject: subject
            }
        });

        const data = await response.json();

        resultDiv.style.display = 'block';

        if (data.success) {
            resultContent.innerHTML = `
                <div class="alert alert-success mb-0">
                    <div class="d-flex align-items-center mb-2">
                        <i data-feather="check-circle" class="me-2"></i>
                        <strong>Test Email Sent Successfully!</strong>
                    </div>
                    <div class="small">
                        <strong>To:</strong> ${data.to_email}<br>
                        <strong>Template:</strong> ${data.template_used || 'Simple Test'}<br>
                        ${data.message_id ? `<strong>Message ID:</strong> <code>${data.message_id}</code>` : ''}
                    </div>
                    <hr class="my-2">
                    <div class="small text-muted">
                        Check your inbox (and spam folder) for the test email.
                    </div>
                </div>
            `;
        } else {
            resultContent.innerHTML = `
                <div class="alert alert-danger mb-0">
                    <div class="d-flex align-items-center mb-2">
                        <i data-feather="alert-circle" class="me-2"></i>
                        <strong>Test Email Failed</strong>
                    </div>
                    <div class="small">${data.message}</div>
                </div>
            `;
        }

        feather.replace();

    } catch (error) {
        console.error('Error:', error);
        resultDiv.style.display = 'block';
        resultContent.innerHTML = `
            <div class="alert alert-danger mb-0">
                <div class="d-flex align-items-center mb-2">
                    <i data-feather="alert-circle" class="me-2"></i>
                    <strong>Error</strong>
                </div>
                <div class="small">Failed to send test email. Please try again.</div>
            </div>
        `;
        feather.replace();
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i data-feather="send" class="me-1"></i> Send Test';
        feather.replace();
    }
}

// =============================================================================
// SendGrid Sync Functions
// =============================================================================
let sendGridTemplates = [];

async function openSendGridSyncModal() {
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('sendGridSyncModal'));
    modal.show();

    // Reset state
    document.getElementById('sgSyncLoading').style.display = 'block';
    document.getElementById('sgSyncError').style.display = 'none';
    document.getElementById('sgSyncContent').style.display = 'none';
    document.getElementById('sgSyncResult').style.display = 'none';

    feather.replace();

    try {
        const response = await csrfFetch('/api/email/sendgrid/templates');

        const data = await response.json();

        document.getElementById('sgSyncLoading').style.display = 'none';

        if (!data.success) {
            document.getElementById('sgSyncError').style.display = 'block';
            document.getElementById('sgSyncErrorMessage').textContent = data.message;
            feather.replace();
            return;
        }

        sendGridTemplates = data.templates || [];
        document.getElementById('sgTemplateCount').textContent = sendGridTemplates.length;

        // Render templates table
        const tbody = document.getElementById('sgTemplatesBody');
        if (sendGridTemplates.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center text-muted py-3">
                        No dynamic templates found in your SendGrid account.
                    </td>
                </tr>
            `;
        } else {
            tbody.innerHTML = sendGridTemplates.map(t => {
                const activeVersion = t.versions?.find(v => v.active) || t.versions?.[0];
                const updatedAt = t.updated_at ? formatDateTime(t.updated_at, { hideSeconds: true }) : '-';

                return `
                    <tr id="sg-row-${t.sendgrid_id}">
                        <td>
                            <strong>${escapeHtml(t.name)}</strong>
                            <div class="small text-muted">${t.sendgrid_id}</div>
                        </td>
                        <td class="small">${activeVersion?.name || '-'}</td>
                        <td class="small">${updatedAt}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="importSendGridTemplate('${t.sendgrid_id}', '${escapeHtml(t.name)}')" id="sg-import-${t.sendgrid_id}">
                                <i data-feather="download" class="me-1"></i> Import
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        document.getElementById('sgSyncContent').style.display = 'block';
        feather.replace();

    } catch (error) {
        console.error('Error:', error);
        document.getElementById('sgSyncLoading').style.display = 'none';
        document.getElementById('sgSyncError').style.display = 'block';
        document.getElementById('sgSyncErrorMessage').textContent = 'Failed to fetch SendGrid templates. Please try again.';
        feather.replace();
    }
}

async function importSendGridTemplate(sendgridId, templateName) {
    const btn = document.getElementById(`sg-import-${sendgridId}`);
    const originalHtml = btn.innerHTML;

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

    try {
        const response = await csrfFetch('/api/email/sendgrid/import', {
            method: 'POST',
            body: {
                sendgrid_template_id: sendgridId
            }
        });

        const data = await response.json();

        if (data.success) {
            // Replace button with success indicator
            btn.classList.remove('btn-outline-primary');
            btn.classList.add('btn-success');
            btn.innerHTML = '<i data-feather="check" class="me-1"></i> Imported';
            btn.disabled = true;
            feather.replace();

            // Reload templates list
            await loadTemplates();

            showSyncResult(true, `Template "${templateName}" imported successfully!`);
        } else {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
            feather.replace();
            showSyncResult(false, data.message);
        }

    } catch (error) {
        console.error('Error:', error);
        btn.disabled = false;
        btn.innerHTML = originalHtml;
        feather.replace();
        showSyncResult(false, 'Failed to import template. Please try again.');
    }
}

async function syncAllSendGridTemplates() {
    const resultDiv = document.getElementById('sgSyncResult');
    const resultContent = document.getElementById('sgSyncResultContent');

    resultDiv.style.display = 'block';
    resultContent.innerHTML = `
        <div class="alert alert-info mb-0">
            <div class="d-flex align-items-center">
                <span class="spinner-border spinner-border-sm me-2"></span>
                Importing all templates...
            </div>
        </div>
    `;

    try {
        const response = await csrfFetch('/api/email/sendgrid/sync', {
            method: 'POST'
        });

        const data = await response.json();

        if (data.success || data.imported_count > 0) {
            resultContent.innerHTML = `
                <div class="alert alert-success mb-0">
                    <div class="d-flex align-items-center mb-2">
                        <i data-feather="check-circle" class="me-2"></i>
                        <strong>Sync Complete!</strong>
                    </div>
                    <div class="small">
                        <strong>Imported:</strong> ${data.imported_count} templates<br>
                        <strong>Skipped:</strong> ${data.skipped_count} (already exist)<br>
                        ${data.failed_count > 0 ? `<strong>Failed:</strong> ${data.failed_count}` : ''}
                    </div>
                    ${data.errors && data.errors.length > 0 ? `
                        <hr class="my-2">
                        <div class="small text-danger">
                            ${data.errors.slice(0, 3).join('<br>')}
                            ${data.errors.length > 3 ? `<br>...and ${data.errors.length - 3} more` : ''}
                        </div>
                    ` : ''}
                </div>
            `;

            // Reload templates list
            await loadTemplates();

            // Refresh the SendGrid templates view
            document.querySelectorAll('[id^="sg-import-"]').forEach(btn => {
                btn.classList.remove('btn-outline-primary');
                btn.classList.add('btn-success');
                btn.innerHTML = '<i data-feather="check" class="me-1"></i> Imported';
                btn.disabled = true;
            });
        } else {
            resultContent.innerHTML = `
                <div class="alert alert-danger mb-0">
                    <div class="d-flex align-items-center mb-2">
                        <i data-feather="alert-circle" class="me-2"></i>
                        <strong>Sync Failed</strong>
                    </div>
                    <div class="small">${data.message}</div>
                </div>
            `;
        }

        feather.replace();

    } catch (error) {
        console.error('Error:', error);
        resultContent.innerHTML = `
            <div class="alert alert-danger mb-0">
                <div class="d-flex align-items-center mb-2">
                    <i data-feather="alert-circle" class="me-2"></i>
                    <strong>Error</strong>
                </div>
                <div class="small">Failed to sync templates. Please try again.</div>
            </div>
        `;
        feather.replace();
    }
}

function showSyncResult(success, message) {
    const resultDiv = document.getElementById('sgSyncResult');
    const resultContent = document.getElementById('sgSyncResultContent');

    resultDiv.style.display = 'block';
    resultContent.innerHTML = `
        <div class="alert alert-${success ? 'success' : 'danger'} mb-0">
            <div class="d-flex align-items-center">
                <i data-feather="${success ? 'check-circle' : 'alert-circle'}" class="me-2"></i>
                <span>${escapeHtml(message)}</span>
            </div>
        </div>
    `;
    feather.replace();
}

// =============================================================================
// Queue Functions
// =============================================================================
let schedulerStatusInterval = null;
let countdownInterval = null;
let nextBatchRunTime = null;

async function loadQueueTab() {
    await Promise.all([
        loadQueueStats(),
        loadSchedulerStatus(),
        loadEmailQueue(),
        loadBatchLogs()
    ]);

    // Start auto-refresh for scheduler status every 30 seconds
    if (schedulerStatusInterval) {
        clearInterval(schedulerStatusInterval);
    }
    schedulerStatusInterval = setInterval(loadSchedulerStatus, 30000);

    // Start countdown update every second
    if (countdownInterval) {
        clearInterval(countdownInterval);
    }
    countdownInterval = setInterval(() => {
        if (nextBatchRunTime) {
            updateCountdown(nextBatchRunTime);
        }
    }, 1000);
}

async function loadSchedulerStatus() {
    try {
        const response = await csrfFetch('/api/admin/scheduler/status');
        if (!response.ok) throw new Error('Failed to load scheduler status');

        const data = await response.json();

        // Find the email batch processor job
        const batchJob = data.jobs.find(job => job.id === 'email_batch_processor');

        if (batchJob && batchJob.next_run_time) {
            nextBatchRunTime = new Date(batchJob.next_run_time);

            // Format the next run time using global formatDateTime
            const formattedTime = formatDateTime(batchJob.next_run_time);

            document.getElementById('nextBatchRun').textContent = formattedTime;

            // Calculate and display countdown
            updateCountdown(nextBatchRunTime);
        } else {
            nextBatchRunTime = null;
            document.getElementById('nextBatchRun').textContent = 'Not scheduled';
            document.getElementById('nextBatchCountdown').textContent = '';
        }
    } catch (error) {
        console.error('Error loading scheduler status:', error);
        nextBatchRunTime = null;
        document.getElementById('nextBatchRun').textContent = 'Error loading status';
        document.getElementById('nextBatchCountdown').textContent = '';
    }
}

function updateCountdown(nextRunTime) {
    const now = new Date();
    const diff = nextRunTime - now;

    if (diff <= 0) {
        document.getElementById('nextBatchCountdown').textContent = 'Running now...';
        // Refresh scheduler status after batch should have run
        setTimeout(() => {
            loadSchedulerStatus();
            loadQueueStats(); // Also refresh queue stats
        }, 5000); // Wait 5 seconds for the batch to complete
        return;
    }

    const minutes = Math.floor(diff / 60000);
    const seconds = Math.floor((diff % 60000) / 1000);

    if (minutes > 0) {
        document.getElementById('nextBatchCountdown').textContent = `in ${minutes}m ${seconds}s`;
    } else {
        document.getElementById('nextBatchCountdown').textContent = `in ${seconds}s`;
    }
}

async function loadQueueStats() {
    try {
        const response = await csrfFetch('/api/admin/email-queue/stats');
        if (!response.ok) throw new Error('Failed to load queue stats');

        const data = await response.json();

        document.getElementById('queueStatPending').textContent = data.pending.toLocaleString();
        document.getElementById('queueStatProcessing').textContent = data.processing.toLocaleString();
        document.getElementById('queueStatSent').textContent = data.sent.toLocaleString();
        document.getElementById('queueStatFailed').textContent = data.failed.toLocaleString();
    } catch (error) {
        console.error('Error loading queue stats:', error);
    }
}

async function loadEmailQueue() {
    // Show loading spinners
    document.getElementById('pendingQueueBody').innerHTML =
        '<tr><td colspan="9" class="text-center py-4"><div class="spinner-border spinner-border-sm me-2"></div>Loading pending emails...</td></tr>';
    document.getElementById('recentQueueBody').innerHTML =
        '<tr><td colspan="9" class="text-center py-4"><div class="spinner-border spinner-border-sm me-2"></div>Loading recent activity...</td></tr>';

    // Disable refresh button
    const refreshButtons = document.querySelectorAll('button[onclick="loadEmailQueue()"]');
    refreshButtons.forEach(btn => {
        btn.disabled = true;
        const icon = btn.querySelector('i[data-feather="refresh-cw"]');
        if (icon) icon.classList.add('spin-animation');
    });

    try {
        // Load pending emails
        const pendingResponse = await csrfFetch('/api/admin/email-queue?page_size=100&status=pending');
        if (!pendingResponse.ok) throw new Error('Failed to load pending queue');
        const pendingData = await pendingResponse.json();

        // Load recent non-pending emails (within past hour)
        const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000).toISOString();
        const recentResponse = await csrfFetch(`/api/admin/email-queue?page_size=100&exclude_status=pending&since=${oneHourAgo}`);
        if (!recentResponse.ok) throw new Error('Failed to load recent queue');
        const recentData = await recentResponse.json();

        // Render both sections
        renderPendingQueueTable(pendingData.items);
        renderRecentQueueTable(recentData.items);
    } catch (error) {
        console.error('Error loading queue:', error);
        document.getElementById('pendingQueueBody').innerHTML =
            '<tr><td colspan="9" class="text-center text-danger py-4">Failed to load pending emails</td></tr>';
        document.getElementById('recentQueueBody').innerHTML =
            '<tr><td colspan="9" class="text-center text-danger py-4">Failed to load recent activity</td></tr>';
    } finally {
        // Re-enable refresh button and stop spin animation
        refreshButtons.forEach(btn => {
            btn.disabled = false;
            const icon = btn.querySelector('i[data-feather="refresh-cw"]');
            if (icon) icon.classList.remove('spin-animation');
        });
        feather.replace();
    }
}

function renderPendingQueueTable(items) {
    const tbody = document.getElementById('pendingQueueBody');
    document.getElementById('pendingCount').textContent = `(${items.length} emails)`;

    if (items.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center py-4 text-muted">No pending emails</td></tr>';
        return;
    }

    tbody.innerHTML = items.map(item => {
        const createdAt = formatDateTime(item.created_at);
        const scheduledFor = item.scheduled_for ? formatDateTime(item.scheduled_for) : '-';
        const batchId = item.batch_id ? `<code class="small">${item.batch_id}</code>` : '-';
        const priorityBadge = item.priority <= 2 ? 'danger' : item.priority <= 5 ? 'warning' : 'secondary';

        return `
            <tr>
                <td class="small">${item.id}</td>
                <td class="small">
                    <div>${item.recipient_name || '-'}</div>
                    <div class="text-muted">${item.recipient_email}</div>
                </td>
                <td><code class="small">${item.template_name}</code></td>
                <td><span class="badge bg-${priorityBadge}">${item.priority}</span></td>
                <td class="small">${item.attempts}/${item.max_attempts}</td>
                <td class="small">${createdAt}</td>
                <td class="small">${scheduledFor}</td>
                <td class="small">${batchId}</td>
                <td>
                    <button class="btn btn-sm btn-outline-danger" onclick="cancelQueuedEmail(${item.id})" title="Cancel">
                        <i data-feather="x"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');

    feather.replace();
}

function renderRecentQueueTable(items) {
    const tbody = document.getElementById('recentQueueBody');
    document.getElementById('recentCount').textContent = `(${items.length} emails)`;

    if (items.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center py-4 text-muted">No recent activity</td></tr>';
        return;
    }

    tbody.innerHTML = items.map(item => {
        const statusBadge = getQueueStatusBadge(item.status);
        const createdAt = formatDateTime(item.created_at);
        const completedAt = item.sent_at || item.processed_at ? formatDateTime(item.sent_at || item.processed_at) : '-';
        const batchId = item.batch_id ? `<code class="small">${item.batch_id}</code>` : '-';
        const priorityBadge = item.priority <= 2 ? 'danger' : item.priority <= 5 ? 'warning' : 'secondary';

        return `
            <tr>
                <td class="small">${item.id}</td>
                <td class="small">
                    <div>${item.recipient_name || '-'}</div>
                    <div class="text-muted">${item.recipient_email}</div>
                </td>
                <td><code class="small">${item.template_name}</code></td>
                <td><span class="badge bg-${priorityBadge}">${item.priority}</span></td>
                <td>${statusBadge}</td>
                <td class="small">${item.attempts}/${item.max_attempts}</td>
                <td class="small">${createdAt}</td>
                <td class="small">${completedAt}</td>
                <td class="small">${batchId}</td>
            </tr>
        `;
    }).join('');

    feather.replace();
}

function getQueueStatusBadge(status) {
    const badges = {
        'pending': '<span class="badge bg-warning">Pending</span>',
        'processing': '<span class="badge bg-info">Processing</span>',
        'sent': '<span class="badge bg-success">Sent</span>',
        'failed': '<span class="badge bg-danger">Failed</span>',
        'cancelled': '<span class="badge bg-secondary">Cancelled</span>'
    };
    return badges[status] || `<span class="badge bg-secondary">${status}</span>`;
}

async function loadBatchLogs() {
    try {
        const response = await csrfFetch('/api/admin/email-batch-logs?page_size=20');
        if (!response.ok) throw new Error('Failed to load batch logs');

        const data = await response.json();
        renderBatchLogsTable(data.items);
    } catch (error) {
        console.error('Error loading batch logs:', error);
        document.getElementById('batchLogsBody').innerHTML =
            '<tr><td colspan="8" class="text-center text-danger py-4">Failed to load batch logs</td></tr>';
    }
}

function renderBatchLogsTable(items) {
    const tbody = document.getElementById('batchLogsBody');

    if (items.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-muted">No batch logs yet</td></tr>';
        return;
    }

    tbody.innerHTML = items.map(log => {
        const startedAt = formatDateTime(log.started_at);
        const completedAt = log.completed_at ? formatDateTime(log.completed_at) : '-';
        const duration = log.duration_seconds ? `${log.duration_seconds}s` : '-';

        return `
            <tr>
                <td class="small"><code>${log.batch_id}</code></td>
                <td class="small">${startedAt}</td>
                <td class="small">${completedAt}</td>
                <td class="small">${duration}</td>
                <td class="small">${log.total_processed}</td>
                <td class="small"><span class="badge bg-success">${log.total_sent}</span></td>
                <td class="small">${log.total_failed > 0 ? `<span class="badge bg-danger">${log.total_failed}</span>` : '0'}</td>
                <td class="small text-muted">${log.processed_by || '-'}</td>
            </tr>
        `;
    }).join('');
}

async function triggerManualBatch() {
    const btn = document.getElementById('manualBatchBtn');
    const originalHtml = btn.innerHTML;

    if (!confirm('Process pending emails in a batch now?')) return;

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Processing...';

    try {
        const response = await csrfFetch('/api/admin/email-queue/process-batch', {
            method: 'POST',
            body: { batch_size: 50 }
        });

        const data = await response.json();

        if (data.success) {
            alert(`Batch processed: ${data.total_sent} sent, ${data.total_failed} failed`);
            await loadQueueTab();
        } else {
            alert('Failed to process batch: ' + data.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to trigger batch processing');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalHtml;
        feather.replace();
    }
}

async function cancelQueuedEmail(emailId) {
    if (!confirm('Cancel this queued email?')) return;

    try {
        const response = await csrfFetch(`/api/admin/email-queue/${emailId}`, {
            method: 'DELETE'
        });

        const data = await response.json();

        if (data.success) {
            alert('Email cancelled successfully');
            await loadEmailQueue();
            await loadQueueStats();
        } else {
            alert('Failed to cancel email: ' + data.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to cancel email');
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
