{% extends "layouts/dashboard.html" %}

{% block title %}Instance Templates{% endblock %}

{% block content %}
<!-- Page Header -->
<header class="page-header page-header-dark bg-gradient-primary-to-secondary pb-10">
    <div class="container-xl px-4">
        <div class="page-header-content pt-4">
            <div class="row align-items-center justify-content-between">
                <div class="col-auto mt-4">
                    <h1 class="page-header-title">
                        <div class="page-header-icon"><i data-feather="layout"></i></div>
                        Instance Templates
                    </h1>
                    <div class="page-header-subtitle">Manage reusable instance configurations for participant self-service</div>
                </div>
                <div class="col-12 col-xl-auto mt-4">
                    <button class="btn btn-sm btn-light" onclick="showCreateModal()">
                        <i data-feather="plus" class="me-1"></i>
                        Create Template
                    </button>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Main Content -->
<div class="container-xl px-4 mt-n10">
    <!-- Filters Card -->
    <div class="card mb-4">
        <div class="card-header">
            <i data-feather="filter" class="me-2"></i>
            Filters
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label small">Event</label>
                    <select class="form-select" id="eventFilter">
                        <option value="">All Events</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Status</label>
                    <select class="form-select" id="activeFilter">
                        <option value="">All</option>
                        <option value="true">Active</option>
                        <option value="false">Inactive</option>
                    </select>
                </div>
                <div class="col-md-5 d-flex align-items-end">
                    <button class="btn btn-primary me-2" onclick="loadTemplates()">
                        <i data-feather="search" class="me-1"></i> Search
                    </button>
                    <button class="btn btn-outline-secondary" onclick="clearFilters()">
                        <i data-feather="x" class="me-1"></i> Clear
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Templates Table -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div><i data-feather="list" class="me-2"></i> Templates</div>
            <span class="small text-muted">
                Showing <span id="showingCount">0</span> of <span id="totalCount">0</span>
            </span>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Event</th>
                            <th>Provider</th>
                            <th>Cloud-Init</th>
                            <th>License</th>
                            <th>Usage</th>
                            <th>Status</th>
                            <th width="120">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="templatesTableBody">
                        <tr>
                            <td colspan="8" class="text-center text-muted py-5">
                                <i data-feather="inbox" class="mb-2"></i>
                                <p>Loading templates...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <nav id="pagination" class="mt-3">
                <!-- Populated dynamically -->
            </nav>
        </div>
    </div>
</div>

<!-- Create/Edit Template Modal -->
<div class="modal fade" id="templateModal" tabindex="-1" aria-labelledby="templateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="templateModalLabel">Create Template</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="templateForm">
                    <input type="hidden" id="templateId">

                    <div class="mb-3">
                        <label class="form-label">Template Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="templateName" required>
                        <div class="form-text">e.g., "Hexio teamserver" or "Redirector"</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="templateDescription" rows="2"></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Event <span class="text-danger">*</span></label>
                        <select class="form-select" id="templateEvent" required>
                            <option value="">Select Event</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Provider <span class="text-danger">*</span></label>
                        <select class="form-select" id="templateProvider" onchange="toggleProviderFields()" required>
                            <option value="openstack">OpenStack</option>
                            <option value="digitalocean">DigitalOcean</option>
                        </select>
                    </div>

                    <!-- OpenStack fields -->
                    <div id="openstackFields">
                        <div class="mb-3">
                            <label class="form-label">Flavor <span class="text-danger">*</span></label>
                            <select class="form-select" id="templateFlavor">
                                <option value="">Select Flavor</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Network <span class="text-danger">*</span></label>
                            <select class="form-select" id="templateNetwork">
                                <option value="">Select Network</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Image <span class="text-danger">*</span></label>
                            <select class="form-select" id="templateImageOS">
                                <option value="">Select Image</option>
                            </select>
                        </div>
                    </div>

                    <!-- DigitalOcean fields -->
                    <div id="digitaloceanFields" style="display:none;">
                        <div class="mb-3">
                            <label class="form-label">Size <span class="text-danger">*</span></label>
                            <select class="form-select" id="templateSize">
                                <option value="">Select Size</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Region <span class="text-danger">*</span></label>
                            <select class="form-select" id="templateRegion">
                                <option value="">Select Region</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Image <span class="text-danger">*</span></label>
                            <select class="form-select" id="templateImageDO">
                                <option value="">Select Image</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Cloud-Init Template</label>
                        <select class="form-select" id="templateCloudInit">
                            <option value="">None</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">License Product</label>
                        <select class="form-select" id="templateLicense">
                            <option value="">None</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Max Instances</label>
                        <input type="number" class="form-control" id="templateMaxInstances" value="0" min="0">
                        <div class="form-text">0 = unlimited</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveTemplate()">Save Template</button>
            </div>
        </div>
    </div>
</div>

<script>
// Global state
let currentPage = 1;
let templates = [];
let templateModal;
let events = [];
let cloudInitTemplates = [];
let licenseProducts = [];

// Provider resources
let openstackFlavors = [];
let openstackNetworks = [];
let openstackImages = [];
let digitaloceanSizes = [];
let digitaloceanRegions = [];
let digitaloceanImages = [];

// CSRF token helper
function getCSRFToken() {
    return document.cookie.split('; ')
        .find(row => row.startsWith('csrf_token='))
        ?.split('=')[1] || '';
}

// Fetch wrapper with CSRF
async function csrfFetch(url, options = {}) {
    return fetch(url, {
        ...options,
        headers: {
            ...options.headers,
            'X-CSRF-Token': getCSRFToken()
        }
    });
}

// Load events for dropdown
async function loadEvents() {
    try {
        const response = await csrfFetch('/api/events');
        const data = await response.json();
        events = data.items || [];

        // Populate event filter
        const eventFilter = document.getElementById('eventFilter');
        events.forEach(event => {
            const option = document.createElement('option');
            option.value = event.id;
            option.textContent = `${event.year} - ${event.name}`;
            eventFilter.appendChild(option);
        });

        // Populate template event dropdown
        const templateEvent = document.getElementById('templateEvent');
        events.forEach(event => {
            const option = document.createElement('option');
            option.value = event.id;
            option.textContent = `${event.year} - ${event.name}`;
            if (event.is_archived) {
                option.disabled = true;
                option.textContent += ' (Archived)';
            }
            templateEvent.appendChild(option);
        });
    } catch (error) {
        console.error('Failed to load events:', error);
    }
}

// Load cloud-init templates
async function loadCloudInitTemplates() {
    try {
        const response = await csrfFetch('/api/cloud-init/templates');
        const data = await response.json();
        cloudInitTemplates = data.items || [];

        const select = document.getElementById('templateCloudInit');
        cloudInitTemplates.forEach(template => {
            const option = document.createElement('option');
            option.value = template.id;
            option.textContent = template.name;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Failed to load cloud-init templates:', error);
    }
}

// Load license products
async function loadLicenseProducts() {
    try {
        const response = await csrfFetch('/api/license/products');
        const data = await response.json();
        licenseProducts = data.items || [];

        const select = document.getElementById('templateLicense');
        licenseProducts.forEach(product => {
            const option = document.createElement('option');
            option.value = product.id;
            option.textContent = product.name;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Failed to load license products:', error);
    }
}

// Load OpenStack resources
async function loadOpenStackResources() {
    try {
        const [flavorsRes, networksRes, imagesRes] = await Promise.all([
            csrfFetch('/api/instances/resources/flavors'),
            csrfFetch('/api/instances/resources/networks'),
            csrfFetch('/api/instances/resources/images')
        ]);

        const flavorsData = await flavorsRes.json();
        const networksData = await networksRes.json();
        const imagesData = await imagesRes.json();

        openstackFlavors = flavorsData.flavors || [];
        openstackNetworks = networksData.networks || [];
        openstackImages = imagesData.images || [];

        // Populate flavor dropdown
        const flavorSelect = document.getElementById('templateFlavor');
        openstackFlavors.forEach(flavor => {
            const option = document.createElement('option');
            option.value = flavor.id;
            option.textContent = `${flavor.name} (${flavor.vcpus} vCPU, ${Math.round(flavor.ram / 1024)}GB RAM)`;
            flavorSelect.appendChild(option);
        });

        // Populate network dropdown
        const networkSelect = document.getElementById('templateNetwork');
        openstackNetworks.forEach(network => {
            const option = document.createElement('option');
            option.value = network.id;
            option.textContent = network.name;
            networkSelect.appendChild(option);
        });

        // Populate image dropdown
        const imageSelect = document.getElementById('templateImageOS');
        openstackImages.forEach(image => {
            const option = document.createElement('option');
            option.value = image.id;
            option.textContent = image.name;
            imageSelect.appendChild(option);
        });
    } catch (error) {
        console.error('Failed to load OpenStack resources:', error);
    }
}

// Load DigitalOcean resources
async function loadDigitalOceanResources() {
    try {
        const [sizesRes, regionsRes, imagesRes] = await Promise.all([
            csrfFetch('/api/instances/resources/digitalocean/sizes'),
            csrfFetch('/api/instances/resources/digitalocean/regions'),
            csrfFetch('/api/instances/resources/digitalocean/images')
        ]);

        const sizesData = await sizesRes.json();
        const regionsData = await regionsRes.json();
        const imagesData = await imagesRes.json();

        digitaloceanSizes = sizesData.sizes || [];
        digitaloceanRegions = regionsData.regions || [];
        digitaloceanImages = imagesData.images || [];

        // Populate size dropdown
        const sizeSelect = document.getElementById('templateSize');
        digitaloceanSizes.forEach(size => {
            const option = document.createElement('option');
            option.value = size.slug;
            option.textContent = `${size.slug} (${size.vcpus} vCPU, ${(size.memory / 1024).toFixed(1)}GB RAM)`;
            sizeSelect.appendChild(option);
        });

        // Populate region dropdown
        const regionSelect = document.getElementById('templateRegion');
        digitaloceanRegions.forEach(region => {
            const option = document.createElement('option');
            option.value = region.slug;
            option.textContent = `${region.name} (${region.slug})`;
            regionSelect.appendChild(option);
        });

        // Populate image dropdown
        const imageSelect = document.getElementById('templateImageDO');
        digitaloceanImages.forEach(image => {
            const option = document.createElement('option');
            option.value = image.slug || image.id;
            option.textContent = image.name || image.slug;
            imageSelect.appendChild(option);
        });
    } catch (error) {
        console.error('Failed to load DigitalOcean resources:', error);
    }
}

// Toggle provider-specific fields
function toggleProviderFields() {
    const provider = document.getElementById('templateProvider').value;
    const osFields = document.getElementById('openstackFields');
    const doFields = document.getElementById('digitaloceanFields');

    if (provider === 'openstack') {
        osFields.style.display = 'block';
        doFields.style.display = 'none';
    } else {
        osFields.style.display = 'none';
        doFields.style.display = 'block';
    }
}

// Load templates
async function loadTemplates() {
    const eventId = document.getElementById('eventFilter').value;
    const isActive = document.getElementById('activeFilter').value;

    const params = new URLSearchParams({
        page: currentPage,
        page_size: 20
    });
    if (eventId) params.append('event_id', eventId);
    if (isActive) params.append('is_active', isActive);

    try {
        const response = await csrfFetch(`/api/admin/instance-templates?${params}`);
        const data = await response.json();

        templates = data.items;
        renderTemplates(data.items);
        renderPagination(data.total_pages, data.page);

        document.getElementById('totalCount').textContent = data.total;
        document.getElementById('showingCount').textContent = data.items.length;

        feather.replace();
    } catch (error) {
        console.error('Failed to load templates:', error);
        showError('Failed to load templates');
    }
}

// Render templates table
function renderTemplates(items) {
    const tbody = document.getElementById('templatesTableBody');

    if (items.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center text-muted py-5">
                    <i data-feather="inbox" class="mb-2"></i>
                    <p>No templates found</p>
                </td>
            </tr>
        `;
        feather.replace();
        return;
    }

    tbody.innerHTML = items.map(t => {
        const usage = t.max_instances > 0 ? `${t.current_instance_count} / ${t.max_instances}` : t.current_instance_count;
        const statusBadge = t.is_active ?
            '<span class="badge bg-success">Active</span>' :
            '<span class="badge bg-secondary">Inactive</span>';
        const providerBadge = t.provider === 'openstack' ?
            '<span class="badge bg-primary">OpenStack</span>' :
            '<span class="badge bg-info">DigitalOcean</span>';

        return `
            <tr>
                <td>
                    <strong>${t.name}</strong>
                    ${t.description ? `<br><small class="text-muted">${t.description}</small>` : ''}
                </td>
                <td>${t.event_name || '-'}</td>
                <td>${providerBadge}</td>
                <td>${t.cloud_init_template_name || '-'}</td>
                <td>${t.license_product_name || '-'}</td>
                <td>${usage}</td>
                <td>${statusBadge}</td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="editTemplate(${t.id})" title="Edit">
                        <i data-feather="edit-2"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteTemplate(${t.id})" title="Delete">
                        <i data-feather="trash-2"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

// Render pagination
function renderPagination(totalPages, currentPageNum) {
    const pagination = document.getElementById('pagination');

    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }

    let html = '<ul class="pagination justify-content-center">';

    // Previous button
    html += `
        <li class="page-item ${currentPageNum === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPageNum - 1}); return false;">Previous</a>
        </li>
    `;

    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPageNum - 2 && i <= currentPageNum + 2)) {
            html += `
                <li class="page-item ${i === currentPageNum ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
                </li>
            `;
        } else if (i === currentPageNum - 3 || i === currentPageNum + 3) {
            html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
        }
    }

    // Next button
    html += `
        <li class="page-item ${currentPageNum === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPageNum + 1}); return false;">Next</a>
        </li>
    `;

    html += '</ul>';
    pagination.innerHTML = html;
}

// Change page
function changePage(page) {
    currentPage = page;
    loadTemplates();
}

// Clear filters
function clearFilters() {
    document.getElementById('eventFilter').value = '';
    document.getElementById('activeFilter').value = '';
    currentPage = 1;
    loadTemplates();
}

// Show create modal
function showCreateModal() {
    document.getElementById('templateModalLabel').textContent = 'Create Template';
    document.getElementById('templateForm').reset();
    document.getElementById('templateId').value = '';
    toggleProviderFields();
    templateModal.show();
}

// Edit template
async function editTemplate(templateId) {
    try {
        const response = await csrfFetch(`/api/admin/instance-templates/${templateId}`);
        const template = await response.json();

        document.getElementById('templateModalLabel').textContent = 'Edit Template';
        document.getElementById('templateId').value = template.id;
        document.getElementById('templateName').value = template.name;
        document.getElementById('templateDescription').value = template.description || '';
        document.getElementById('templateEvent').value = template.event_id;
        document.getElementById('templateProvider').value = template.provider;
        document.getElementById('templateMaxInstances').value = template.max_instances;
        document.getElementById('templateCloudInit').value = template.cloud_init_template_id || '';
        document.getElementById('templateLicense').value = template.license_product_id || '';

        toggleProviderFields();

        if (template.provider === 'openstack') {
            document.getElementById('templateFlavor').value = template.flavor_id || '';
            document.getElementById('templateNetwork').value = template.network_id || '';
            document.getElementById('templateImageOS').value = template.image_id || '';
        } else {
            document.getElementById('templateSize').value = template.provider_size_slug || '';
            document.getElementById('templateRegion').value = template.provider_region || '';
            document.getElementById('templateImageDO').value = template.image_id || '';
        }

        templateModal.show();
    } catch (error) {
        console.error('Failed to load template:', error);
        showError('Failed to load template');
    }
}

// Save template
async function saveTemplate() {
    const templateId = document.getElementById('templateId').value;
    const provider = document.getElementById('templateProvider').value;

    const data = {
        name: document.getElementById('templateName').value,
        description: document.getElementById('templateDescription').value || null,
        event_id: parseInt(document.getElementById('templateEvent').value),
        provider: provider,
        cloud_init_template_id: document.getElementById('templateCloudInit').value ?
            parseInt(document.getElementById('templateCloudInit').value) : null,
        license_product_id: document.getElementById('templateLicense').value ?
            parseInt(document.getElementById('templateLicense').value) : null,
        max_instances: parseInt(document.getElementById('templateMaxInstances').value)
    };

    if (provider === 'openstack') {
        data.flavor_id = document.getElementById('templateFlavor').value;
        data.network_id = document.getElementById('templateNetwork').value;
        data.image_id = document.getElementById('templateImageOS').value;
    } else {
        data.provider_size_slug = document.getElementById('templateSize').value;
        data.provider_region = document.getElementById('templateRegion').value;
        data.image_id = document.getElementById('templateImageDO').value;
    }

    try {
        let response;
        if (templateId) {
            // Update
            response = await csrfFetch(`/api/admin/instance-templates/${templateId}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: data.name,
                    description: data.description,
                    max_instances: data.max_instances
                })
            });
        } else {
            // Create
            response = await csrfFetch('/api/admin/instance-templates', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
        }

        if (response.ok) {
            templateModal.hide();
            loadTemplates();
            showSuccess(templateId ? 'Template updated' : 'Template created');
        } else {
            const error = await response.json();
            showError(error.detail || 'Failed to save template');
        }
    } catch (error) {
        console.error('Failed to save template:', error);
        showError('Failed to save template');
    }
}

// Delete template
async function deleteTemplate(templateId) {
    if (!confirm('Are you sure you want to delete this template? This cannot be undone.')) {
        return;
    }

    try {
        const response = await csrfFetch(`/api/admin/instance-templates/${templateId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            loadTemplates();
            showSuccess('Template deleted');
        } else {
            const error = await response.json();
            showError(error.detail || 'Failed to delete template');
        }
    } catch (error) {
        console.error('Failed to delete template:', error);
        showError('Failed to delete template');
    }
}

// Show success message
function showSuccess(message) {
    // You can implement a toast notification here
    alert(message);
}

// Show error message
function showError(message) {
    // You can implement a toast notification here
    alert(message);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', async () => {
    templateModal = new bootstrap.Modal(document.getElementById('templateModal'));

    // Load all dropdown data
    await Promise.all([
        loadEvents(),
        loadCloudInitTemplates(),
        loadLicenseProducts(),
        loadOpenStackResources(),
        loadDigitalOceanResources()
    ]);

    // Load templates
    await loadTemplates();

    feather.replace();
});
</script>

{% endblock %}
