{% extends "layouts/dashboard.html" %}

{% block title %}User Management{% endblock %}

{% block extra_css %}
<style>
/* User Management Tab Styling */
#userTabs {
    border-bottom: none;
    margin: 0;
}

#userTabs .nav-item {
    margin-bottom: 0;
}

#userTabs .nav-link {
    border: 1px solid transparent;
    border-bottom: none;
    border-radius: 0.375rem 0.375rem 0 0;
    padding: 0.75rem 1.25rem;
    color: #6c757d;
    background: transparent;
    margin-top: 0.5rem;
    transition: all 0.15s ease-in-out;
}

#userTabs .nav-link:hover {
    color: #0061f2;
    border-color: transparent;
}

#userTabs .nav-link.active {
    color: #0061f2;
    background-color: #fff;
    border-color: #dee2e6 #dee2e6 #fff;
    margin-top: 0;
    padding-top: 1rem;
    font-weight: 600;
}

.card-header.p-0 {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
    padding-left: 0.5rem !important;
}

/* Role badges */
.badge-admin { background-color: #e81500; }
.badge-sponsor { background-color: #6900c7; }
.badge-invitee { background-color: #0061f2; }

/* Checkbox styling for bulk select */
.user-checkbox {
    width: 18px;
    height: 18px;
    cursor: pointer;
}
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<header class="page-header page-header-dark bg-gradient-primary-to-secondary pb-10">
    <div class="container-fluid px-4">
        <div class="page-header-content pt-4">
            <div class="row align-items-center justify-content-between">
                <div class="col-auto mt-4">
                    <h1 class="page-header-title">
                        <div class="page-header-icon"><i data-feather="user-check"></i></div>
                        Participant Management
                    </h1>
                    <div class="page-header-subtitle">Manage all invitees, roles, and sponsor assignments</div>
                </div>
                <div class="col-12 col-xl-auto mt-4">
                    <button class="btn btn-sm btn-light" onclick="openCreateUserModal()">
                        <i data-feather="user-plus" class="me-1"></i>
                        Add Invitee
                    </button>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Main Content -->
<div class="container-fluid px-4 mt-n10">
    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="card stats-card bg-success text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="text-white-75 small">Confirmed</div>
                            <div class="fs-3 fw-bold" id="statConfirmed">-</div>
                        </div>
                        <i data-feather="check-circle" class="feather-xl text-white-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card stats-card bg-primary text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="text-white-75 small">With VPN</div>
                            <div class="fs-3 fw-bold" id="statWithVpn">-</div>
                        </div>
                        <i data-feather="shield" class="feather-xl text-white-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card stats-card bg-info text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="text-white-75 small">Active</div>
                            <div class="fs-3 fw-bold" id="statActive">-</div>
                        </div>
                        <i data-feather="user-check" class="feather-xl text-white-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card stats-card bg-secondary text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="text-white-75 small">Total Invitees</div>
                            <div class="fs-3 fw-bold" id="statTotal">-</div>
                        </div>
                        <i data-feather="users" class="feather-xl text-white-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="card mb-4">
        <div class="card-header p-0">
            <ul class="nav nav-tabs card-header-tabs" id="userTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#all" type="button" role="tab">
                        <i data-feather="list" class="me-1"></i> Participants
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="admins-tab" data-bs-toggle="tab" data-bs-target="#admins" type="button" role="tab">
                        <i data-feather="shield" class="me-1"></i> Admins
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="sponsors-tab" data-bs-toggle="tab" data-bs-target="#sponsors" type="button" role="tab">
                        <i data-feather="award" class="me-1"></i> Sponsors
                    </button>
                </li>
            </ul>
        </div>
    </div>

    <!-- Tab Content -->
    <div class="tab-content" id="userTabsContent">
        <!-- All Users Tab -->
        <div class="tab-pane fade show active" id="all" role="tabpanel">
            <!-- Filters -->
            <div class="card mb-4">
                <div class="card-header">
                    <i data-feather="filter" class="me-2"></i>
                    Filters
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label small">Search</label>
                            <input type="text" class="form-control" id="userSearch" placeholder="Name, email...">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small">Role</label>
                            <select class="form-select" id="userRoleFilter">
                                <option value="">All Roles</option>
                                <option value="admin">Admin</option>
                                <option value="sponsor">Sponsor</option>
                                <option value="invitee">Invitee</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small">Invitee Status</label>
                            <select class="form-select" id="userStatusFilter">
                                <option value="">All</option>
                                <option value="true">Active</option>
                                <option value="false">Inactive</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small">Confirmation Status</label>
                            <select class="form-select" id="userConfirmedFilter">
                                <option value="" selected>All</option>
                                <option value="YES">Confirmed</option>
                                <option value="NO">Declined</option>
                                <option value="UNKNOWN">Pending</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small">Email Status</label>
                            <select class="form-select" id="userEmailStatusFilter">
                                <option value="">All</option>
                                <option value="GOOD">Good</option>
                                <option value="BAD">Bad</option>
                                <option value="BOUNCED">Bounced</option>
                                <option value="SPAM_REPORTED">Spam</option>
                                <option value="UNSUBSCRIBE">Unsubscribed</option>
                                <option value="UNKNOWN">Unknown</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small">Country</label>
                            <select class="form-select" id="userCountryFilter">
                                <option value="">All Countries</option>
                                <option value="United States">üá∫üá∏ United States</option>
                                <option value="Canada">üá®üá¶ Canada</option>
                                <option value="United Kingdom">üá¨üáß United Kingdom</option>
                            </select>
                        </div>
                        <div class="col-md-1 d-flex align-items-end gap-1">
                            <button class="btn btn-primary" onclick="loadUsers(1)" title="Search">
                                <i data-feather="search"></i>
                            </button>
                            <button class="btn btn-outline-secondary" onclick="clearFilters()" title="Clear filters">
                                <i data-feather="x"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Table -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <i data-feather="users" class="me-2"></i>
                        Participants
                        <span class="badge bg-secondary ms-2" id="userCountBadge">0</span>
                    </div>
                    <div>
                        <div class="dropdown d-inline-block me-2">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" id="bulkActionsBtn" disabled>
                                <i data-feather="layers" class="me-1"></i> Bulk Actions
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="bulkAction('activate')"><i data-feather="check-circle" class="me-2"></i>Activate</a></li>
                                <li><a class="dropdown-item" href="#" onclick="bulkAction('deactivate')"><i data-feather="x-circle" class="me-2"></i>Deactivate</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" onclick="bulkResendInvitation()"><i data-feather="send" class="me-2"></i>Resend Invitation</a></li>
                                <li><a class="dropdown-item" href="#" onclick="bulkResetWorkflow()"><i data-feather="refresh-cw" class="me-2"></i>Reset Workflow State</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showAssignActionModal()"><i data-feather="check-square" class="me-2"></i>Assign Action</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="#" onclick="bulkAction('delete')"><i data-feather="trash-2" class="me-2"></i>Delete</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="usersTable">
                            <thead>
                                <tr>
                                    <th width="40">
                                        <input type="checkbox" class="form-check-input user-checkbox" id="selectAllUsers" onchange="toggleSelectAll(this)">
                                    </th>
                                    <th width="220">Name</th>
                                    <th width="260">Email</th>
                                    <th width="80">Country</th>
                                    <th width="130">Email Status</th>
                                    <th width="90">Role</th>
                                    <th width="180">Sponsor</th>
                                    <th width="90">Active</th>
                                    <th width="110">Status</th>
                                    <th width="160" onclick="sortTable('confirmed_at')" style="cursor: pointer;" title="Click to sort">
                                        Status Date <span id="sortIndicator"></span>
                                    </th>
                                    <th width="120">Participation</th>
                                    <th width="130">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersBody">
                                <tr>
                                    <td colspan="12" class="text-center py-4">
                                        <div class="spinner-border spinner-border-sm me-2"></div>
                                        Loading users...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <!-- Pagination -->
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div class="small text-muted" id="paginationInfo">Showing 0 of 0</div>
                        <nav>
                            <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admins Tab -->
        <div class="tab-pane fade" id="admins" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <i data-feather="shield" class="me-2"></i>
                    Administrators
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th width="100">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="adminsBody">
                                <tr>
                                    <td colspan="5" class="text-center py-4">
                                        <div class="spinner-border spinner-border-sm me-2"></div>
                                        Loading...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sponsors Tab -->
        <div class="tab-pane fade" id="sponsors" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <i data-feather="award" class="me-2"></i>
                    Sponsors
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Sponsored Users</th>
                                    <th>Status</th>
                                    <th width="100">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="sponsorsBody">
                                <tr>
                                    <td colspan="5" class="text-center py-4">
                                        <div class="spinner-border spinner-border-sm me-2"></div>
                                        Loading...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit User Modal -->
<div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userModalTitle">
                    <i data-feather="user-plus" class="me-2"></i>
                    Add Invitee
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <input type="hidden" id="userId">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">First Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="userFirstName" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Last Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="userLastName" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="userEmail" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Country</label>
                            <select class="form-select" id="userCountry">
                                <option value="">Select country...</option>
                                <option value="United States">üá∫üá∏ United States</option>
                                <option value="Canada">üá®üá¶ Canada</option>
                                <option value="United Kingdom">üá¨üáß United Kingdom</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Role <span class="text-danger">*</span></label>
                            <select class="form-select" id="userRole" required>
                                <option value="invitee">Invitee</option>
                                <option value="sponsor">Sponsor</option>
                                <option value="admin">Admin</option>
                            </select>
                            <div class="form-text">Admins have full access. Sponsors can manage their invitees.</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Sponsor</label>
                            <select class="form-select" id="userSponsor">
                                <option value="">No Sponsor</option>
                            </select>
                            <div class="form-text">Assign a sponsor to manage this user.</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Confirmation Status</label>
                            <select class="form-select" id="userConfirmed" disabled>
                                <option value="UNKNOWN">Unknown</option>
                                <option value="YES">Confirmed</option>
                                <option value="NO">Not Confirmed</option>
                            </select>
                            <div class="form-text text-muted">
                                <i data-feather="info" class="feather-xs"></i>
                                Confirmation status can only be changed through the confirmation flow (invite ‚Üí confirm/decline).
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Active Status</label>
                            <div class="form-check form-switch mt-2">
                                <input class="form-check-input" type="checkbox" id="userActive" checked>
                                <label class="form-check-label" for="userActive">Invitee is active</label>
                            </div>
                        </div>
                        <div class="col-12" id="emailStatusSection" style="display: none;">
                            <div class="alert alert-info mb-0">
                                <div class="d-flex align-items-center">
                                    <i data-feather="mail" class="me-2"></i>
                                    <div>
                                        <strong>Email Deliverability Status:</strong>
                                        <span id="userEmailStatus" class="ms-2"></span>
                                        <div class="small text-muted mt-1">
                                            This status is automatically updated by SendGrid webhook events and cannot be manually edited.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-12" id="credentialsSection" style="display: none;">
                            <hr>
                            <h6 class="mb-3">Login Credentials</h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Username</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="userPandasUsername" readonly>
                                        <button class="btn btn-outline-secondary" type="button" onclick="copyUsername()" title="Copy username">
                                            <i data-feather="copy"></i>
                                        </button>
                                    </div>
                                    <small class="text-muted">Auto-generated when user confirms participation</small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Password</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="userPandasPassword" placeholder="Enter password">
                                        <button class="btn btn-outline-secondary" type="button" onclick="copyPassword()" title="Copy password">
                                            <i data-feather="copy"></i>
                                        </button>
                                        <button class="btn btn-outline-secondary" type="button" onclick="resetUserPassword()" title="Generate new password">
                                            <i data-feather="refresh-cw"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveUser()" id="saveUserBtn">
                    <i data-feather="save" class="me-1"></i> Save Invitee
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Role Change Modal -->
<div class="modal fade" id="roleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i data-feather="shield" class="me-2"></i>
                    Change User Role
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Change role for: <strong id="roleUserName"></strong></p>
                <input type="hidden" id="roleUserId">
                <div class="mb-3">
                    <label class="form-label">New Role</label>
                    <select class="form-select" id="newRole">
                        <option value="invitee">Invitee</option>
                        <option value="sponsor">Sponsor</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div class="alert alert-warning small">
                    <i data-feather="alert-triangle" class="me-2"></i>
                    <strong>Warning:</strong> Changing a user's role will affect their access permissions immediately.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveRoleChange()">
                    <i data-feather="check" class="me-1"></i> Change Role
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i data-feather="trash-2" class="me-2"></i>
                    Confirm Delete
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong id="deleteUserName"></strong>?</p>
                <input type="hidden" id="deleteUserId">
                <div class="alert alert-danger small">
                    <i data-feather="alert-circle" class="me-2"></i>
                    This action cannot be undone. All user data will be permanently removed.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                    <i data-feather="trash-2" class="me-1"></i> Delete User
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Assign Action Modal -->
<div class="modal fade" id="assignActionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i data-feather="check-square" class="me-2"></i>
                    Assign Action to Participants
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="assignActionError" class="alert alert-danger d-none" role="alert"></div>

                <form id="assignActionForm">
                    <div class="mb-3">
                        <label class="form-label">Action Type</label>
                        <select class="form-select" id="actionType" required>
                            <option value="in_person_attendance">In-Person Attendance</option>
                            <option value="orientation_rsvp">Orientation RSVP</option>
                            <option value="survey_completion">Survey Completion</option>
                            <option value="document_review">Document Review</option>
                            <option value="custom">Custom Action</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Title <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="actionTitle"
                               placeholder="e.g., Confirm In-Person Attendance" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Description (Optional)</label>
                        <textarea class="form-control" id="actionDescription" rows="3"
                                  placeholder="Additional details about this action"></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Deadline (Optional)</label>
                        <input type="datetime-local" class="form-control" id="actionDeadline">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Email Template (Optional)</label>
                        <select class="form-select" id="actionEmailTemplate">
                            <option value="">Use default action notification</option>
                        </select>
                        <div class="form-text">
                            Custom SendGrid template for action notification email
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="sendNotification" checked>
                            <label class="form-check-label" for="sendNotification">
                                Send email notification to participants
                            </label>
                        </div>
                    </div>

                    <div class="alert alert-info small">
                        <i data-feather="info" class="me-1"></i>
                        This action will be assigned to <strong id="actionTargetCount">0</strong> participant(s).
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitAssignAction()">
                    <i data-feather="check-square" class="me-1"></i> Assign Action
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
(function() {
'use strict';

// =============================================================================
// State
// =============================================================================
let users = [];
let sponsors = [];
let selectedUsers = new Set();
let currentPage = 1;
let totalPages = 1;
let pageSize = 25;
let sortBy = 'created_at';
let sortOrder = 'desc';

// =============================================================================
// Helper Functions
// =============================================================================

// Use global formatDateTime function from dashboard.html with fallback
const formatDateTime = window.formatDateTime || function(dateStr) {
    if (!dateStr) return '';
    try {
        const date = new Date(dateStr);
        return date.toLocaleString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch (e) {
        return dateStr;
    }
};

// =============================================================================
// Initialization
// =============================================================================
document.addEventListener('DOMContentLoaded', () => {
    loadStats();
    loadUsers(1);
    loadSponsors();

    // Tab change handlers
    document.querySelectorAll('#userTabs button').forEach(tab => {
        tab.addEventListener('shown.bs.tab', (e) => {
            const target = e.target.getAttribute('data-bs-target');
            if (target === '#admins') loadAdmins();
            if (target === '#sponsors') loadSponsorsList();
        });
    });

    // Search on Enter
    document.getElementById('userSearch').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') loadUsers(1);
    });

    feather.replace();
});

// =============================================================================
// Data Loading
// =============================================================================
async function loadStats() {
    try {
        const response = await csrfFetch('/api/admin/participants/stats');
        const stats = await response.json();

        document.getElementById('statConfirmed').textContent = stats.confirmed_count || 0;
        document.getElementById('statWithVpn').textContent = stats.with_vpn_count || 0;
        document.getElementById('statActive').textContent = stats.active_count || 0;
        document.getElementById('statTotal').textContent = stats.total_invitees || 0;
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

window.loadUsers = async function(page = 1) {
    currentPage = page;
    const search = document.getElementById('userSearch').value;
    const role = document.getElementById('userRoleFilter').value;
    const isActive = document.getElementById('userStatusFilter').value;
    const confirmed = document.getElementById('userConfirmedFilter').value;
    const emailStatus = document.getElementById('userEmailStatusFilter').value;
    const country = document.getElementById('userCountryFilter').value;

    const params = new URLSearchParams({
        page: page,
        page_size: pageSize,
        sort_by: sortBy,
        sort_order: sortOrder
    });

    if (search) params.append('search', search);
    if (role) params.append('role', role);
    if (isActive) params.append('is_active', isActive);
    if (confirmed) params.append('confirmed', confirmed);
    if (emailStatus) params.append('email_status', emailStatus);
    if (country) params.append('country', country);

    try {
        const response = await csrfFetch(`/api/admin/participants?${params}`);
        const data = await response.json();

        users = data.items || [];
        totalPages = data.total_pages || 1;

        renderUsersTable();
        renderPagination(data.total || 0);
        document.getElementById('userCountBadge').textContent = data.total || 0;
        updateSortIndicator();

    } catch (error) {
        console.error('Error loading users:', error);
        document.getElementById('usersBody').innerHTML = `
            <tr>
                <td colspan="12" class="text-center text-danger py-4">
                    Failed to load users. Please try again.
                </td>
            </tr>
        `;
    }
}

async function loadSponsors() {
    try {
        const response = await csrfFetch('/api/admin/sponsors');

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        console.log('Sponsors loaded:', data);

        // Ensure sponsors is an array
        sponsors = Array.isArray(data) ? data : [];
        updateSponsorDropdown();
    } catch (error) {
        console.error('Error loading sponsors:', error);
        sponsors = []; // Set to empty array on error
        updateSponsorDropdown(); // Still update dropdown with empty list
    }
}

async function loadAdmins() {
    try {
        const response = await csrfFetch('/api/admin/participants?role=admin&page_size=100');
        const data = await response.json();

        const tbody = document.getElementById('adminsBody');
        if (!data.items || data.items.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">No administrators found</td></tr>';
            return;
        }

        tbody.innerHTML = data.items.map(user => `
            <tr>
                <td>
                    <strong>${escapeHtml(user.first_name)} ${escapeHtml(user.last_name)}</strong>
                </td>
                <td>${escapeHtml(user.email)}</td>
                <td>${user.is_active ? '<span class="badge bg-success">Active</span>' : '<span class="badge bg-secondary">Inactive</span>'}</td>
                <td class="small">${user.created_at ? formatDate(user.created_at) : '-'}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="editUser(${user.id})">
                        <i data-feather="edit-2"></i>
                    </button>
                </td>
            </tr>
        `).join('');

        feather.replace();
    } catch (error) {
        console.error('Error loading admins:', error);
    }
}

async function loadSponsorsList() {
    try {
        const response = await csrfFetch('/api/admin/sponsors');
        const sponsorList = await response.json();

        const tbody = document.getElementById('sponsorsBody');
        if (!sponsorList || sponsorList.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">No sponsors found</td></tr>';
            return;
        }

        // Get sponsored counts
        const sponsoredCounts = {};
        for (const sponsor of sponsorList) {
            try {
                const countRes = await csrfFetch(`/api/admin/participants?sponsor_id=${sponsor.id}&page_size=1`);
                const countData = await countRes.json();
                sponsoredCounts[sponsor.id] = countData.total || 0;
            } catch {
                sponsoredCounts[sponsor.id] = 0;
            }
        }

        tbody.innerHTML = sponsorList.map(sponsor => `
            <tr>
                <td>
                    <strong>${escapeHtml(sponsor.first_name)} ${escapeHtml(sponsor.last_name)}</strong>
                    ${sponsor.role === 'admin' ? '<span class="badge bg-danger ms-2">Admin</span>' : ''}
                </td>
                <td>${escapeHtml(sponsor.email)}</td>
                <td><span class="badge bg-info">${sponsoredCounts[sponsor.id] || 0} users</span></td>
                <td>${sponsor.is_active ? '<span class="badge bg-success">Active</span>' : '<span class="badge bg-secondary">Inactive</span>'}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="editUser(${sponsor.id})">
                        <i data-feather="edit-2"></i>
                    </button>
                </td>
            </tr>
        `).join('');

        feather.replace();
    } catch (error) {
        console.error('Error loading sponsors:', error);
    }
}

// =============================================================================
// Rendering
// =============================================================================
function renderUsersTable() {
    const tbody = document.getElementById('usersBody');

    if (users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="12" class="text-center py-4 text-muted">No invitees found</td></tr>';
        return;
    }

    tbody.innerHTML = users.map(user => `
        <tr>
            <td>
                <input type="checkbox" class="form-check-input user-checkbox" value="${user.id}"
                    ${selectedUsers.has(user.id) ? 'checked' : ''} onchange="toggleUserSelection(${user.id})">
            </td>
            <td>
                <strong>${escapeHtml(user.first_name)} ${escapeHtml(user.last_name)}</strong>
                ${user.pandas_username ? `<div class="small text-muted">@${escapeHtml(user.pandas_username)}</div>` : ''}
            </td>
            <td>${escapeHtml(user.email)}</td>
            <td class="text-center">${user.country ? `<span title="${escapeHtml(user.country)}" style="font-size: 1.5rem; cursor: help;">${getCountryFlag(user.country)}</span>` : '<span class="text-muted">-</span>'}</td>
            <td>${getEmailStatusBadge(user.email_status)}</td>
            <td>${getRoleBadge(user.role)}</td>
            <td>${user.sponsor ? escapeHtml(user.sponsor.first_name + ' ' + user.sponsor.last_name) : '<span class="text-muted">-</span>'}</td>
            <td>${user.is_active ? '<span class="badge bg-success">Active</span>' : '<span class="badge bg-secondary">Inactive</span>'}</td>
            <td>${getConfirmedBadge(user)}</td>
            <td class="small">${user.confirmed_at ? formatDateTime(user.confirmed_at) : '<span class="text-muted">-</span>'}</td>
            <td>
                <span class="small" title="Years participated / Years invited">
                    ${user.years_participated || 0}/${user.years_invited || 0}
                    ${user.is_chronic_non_participant
                        ? '<span class="badge bg-danger ms-1" title="Chronic non-participant">!</span>'
                        : user.should_recommend_removal
                        ? '<span class="badge bg-warning ms-1" title="Recommend removal">?</span>'
                        : ''}
                </span>
            </td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="editUser(${user.id})" title="Edit">
                        <i data-feather="edit-2"></i>
                    </button>
                    ${(() => {
                        const status = user.event_participation_status || user.confirmed;
                        const notConfirmed = status !== 'YES' && status !== 'confirmed';
                        return notConfirmed && user.is_active && (user.role === 'invitee' || user.role === 'sponsor')
                            ? `<button class="btn btn-outline-info" onclick="resendInvitation(${user.id}, '${escapeHtml(user.email)}')" title="Resend Invitation">
                                <i data-feather="send"></i>
                               </button>`
                            : '';
                    })()}
                    ${user.role === 'invitee' || user.role === 'sponsor'
                        ? `<button class="btn btn-outline-warning" onclick="resetWorkflow(${user.id}, '${escapeHtml(user.email)}')" title="Reset Workflow State">
                            <i data-feather="refresh-cw"></i>
                           </button>`
                        : ''}
                    <button class="btn btn-outline-secondary" onclick="openRoleModal(${user.id}, '${escapeHtml(user.first_name)} ${escapeHtml(user.last_name)}', '${user.role}')" title="Change Role">
                        <i data-feather="shield"></i>
                    </button>
                    <button class="btn btn-outline-danger" onclick="openDeleteModal(${user.id}, '${escapeHtml(user.first_name)} ${escapeHtml(user.last_name)}')" title="Delete">
                        <i data-feather="trash-2"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');

    feather.replace();
}

function renderPagination(total) {
    const info = document.getElementById('paginationInfo');
    const start = (currentPage - 1) * pageSize + 1;
    const end = Math.min(currentPage * pageSize, total);
    info.textContent = `Showing ${start}-${end} of ${total}`;

    const pagination = document.getElementById('pagination');
    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }

    let html = '';
    html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="loadUsers(${currentPage - 1}); return false;">Previous</a>
    </li>`;

    for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
            html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="loadUsers(${i}); return false;">${i}</a>
            </li>`;
        } else if (i === currentPage - 3 || i === currentPage + 3) {
            html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
    }

    html += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="loadUsers(${currentPage + 1}); return false;">Next</a>
    </li>`;

    pagination.innerHTML = html;
}

function getRoleBadge(role) {
    const badges = {
        'admin': '<span class="badge badge-admin">Admin</span>',
        'sponsor': '<span class="badge badge-sponsor">Sponsor</span>',
        'invitee': '<span class="badge badge-invitee">Invitee</span>'
    };
    return badges[role] || '<span class="badge bg-secondary">Unknown</span>';
}

function getConfirmedBadge(user) {
    // Prefer event_participation_status (new), fall back to confirmed (legacy)
    const status = user.event_participation_status || user.confirmed;

    // Map both new and legacy status values
    const statusMap = {
        // New EventParticipation status values
        'confirmed': 'YES',
        'declined': 'NO',
        'invited': 'UNKNOWN',
        'no_response': 'UNKNOWN',
        // Legacy values
        'YES': 'YES',
        'NO': 'NO',
        'UNKNOWN': 'UNKNOWN'
    };

    const mappedStatus = statusMap[status] || 'UNKNOWN';

    const badges = {
        'YES': '<span class="badge bg-success">Confirmed</span>',
        'NO': '<span class="badge bg-danger">Declined</span>',
        'UNKNOWN': '<span class="badge bg-warning">Pending</span>'
    };

    return badges[mappedStatus] || '<span class="badge bg-secondary">-</span>';
}

function getEmailStatusBadge(emailStatus) {
    const badges = {
        'GOOD': '<span class="badge bg-success" title="Email is deliverable">Good</span>',
        'BAD': '<span class="badge bg-danger" title="Email bounced, dropped, or marked as spam">Bad</span>',
        'BOUNCED': '<span class="badge bg-danger" title="Email bounced">Bounced</span>',
        'SPAM_REPORTED': '<span class="badge bg-danger" title="Recipient reported as spam">Spam</span>',
        'UNSUBSCRIBE': '<span class="badge bg-warning" title="Recipient unsubscribed">Unsubscribed</span>',
        'UNKNOWN': '<span class="badge bg-secondary" title="Email status not yet verified">Unknown</span>'
    };
    return badges[emailStatus] || '<span class="badge bg-secondary">-</span>';
}

function getCountryFlag(country) {
    const flags = {
        'United States': 'üá∫üá∏',
        'Canada': 'üá®üá¶',
        'United Kingdom': 'üá¨üáß'
    };
    return flags[country] || 'üåê';
}

function formatCountryDisplay(country) {
    if (!country) return '<span class="text-muted">-</span>';
    const flag = getCountryFlag(country);
    return `<span title="${escapeHtml(country)}">${flag} ${escapeHtml(country)}</span>`;
}

function updateSponsorDropdown() {
    const select = document.getElementById('userSponsor');

    // Ensure sponsors is an array
    if (!Array.isArray(sponsors)) {
        console.warn('Sponsors is not an array:', sponsors);
        sponsors = [];
    }

    select.innerHTML = '<option value="">No Sponsor</option>' +
        sponsors.map(s => `<option value="${s.id}">${escapeHtml(s.first_name)} ${escapeHtml(s.last_name)} (${s.email})</option>`).join('');
}

// =============================================================================
// User CRUD
// =============================================================================
window.openCreateUserModal = function() {
    try {
        console.log('Opening create user modal...');
        document.getElementById('userModalTitle').innerHTML = '<i data-feather="user-plus" class="me-2"></i>Add Invitee';
        document.getElementById('userId').value = '';
        document.getElementById('userForm').reset();
        document.getElementById('userActive').checked = true;
        document.getElementById('userConfirmed').value = 'UNKNOWN';  // Default for new users
        document.getElementById('credentialsSection').style.display = 'none';
        document.getElementById('emailStatusSection').style.display = 'none';
        updateSponsorDropdown();

        const modalEl = document.getElementById('userModal');
        const modal = new bootstrap.Modal(modalEl);
        modal.show();

        // Replace feather icons after modal is shown
        setTimeout(() => {
            if (typeof feather !== 'undefined') {
                feather.replace();
            }
        }, 100);
    } catch (error) {
        console.error('Error opening create modal:', error);
        alert('Error opening modal: ' + error.message);
    }
}

window.editUser = async function(userId) {
    try {
        console.log('Editing user:', userId);
        const response = await csrfFetch(`/api/admin/participants/${userId}`);

        if (!response.ok) {
            throw new Error('Failed to load user data');
        }

        const user = await response.json();
        console.log('User data loaded:', user);

        document.getElementById('userModalTitle').innerHTML = '<i data-feather="edit" class="me-2"></i>Edit Invitee';
        document.getElementById('userId').value = user.id;
        document.getElementById('userFirstName').value = user.first_name || '';
        document.getElementById('userLastName').value = user.last_name || '';
        document.getElementById('userEmail').value = user.email || '';
        document.getElementById('userCountry').value = user.country || '';
        document.getElementById('userRole').value = user.role || 'invitee';
        document.getElementById('userConfirmed').value = user.confirmed || 'UNKNOWN';
        document.getElementById('userActive').checked = user.is_active !== false;

        updateSponsorDropdown();
        document.getElementById('userSponsor').value = user.sponsor_id || '';

        // Show credentials section
        document.getElementById('credentialsSection').style.display = 'block';
        document.getElementById('userPandasUsername').value = user.pandas_username || '';
        document.getElementById('userPandasPassword').value = user.pandas_password || '';

        // Show email status section (read-only)
        document.getElementById('emailStatusSection').style.display = 'block';
        document.getElementById('userEmailStatus').innerHTML = getEmailStatusBadge(user.email_status);

        const modalEl = document.getElementById('userModal');
        const modal = new bootstrap.Modal(modalEl);
        modal.show();

        // Replace feather icons after modal is shown
        setTimeout(() => {
            if (typeof feather !== 'undefined') {
                feather.replace();
            }
        }, 100);
    } catch (error) {
        console.error('Error loading user:', error);
        alert('Failed to load user details: ' + error.message);
    }
}

window.saveUser = async function() {
    const userId = document.getElementById('userId').value;
    const isEdit = !!userId;

    // Get sponsor ID and convert to integer or null
    const sponsorValue = document.getElementById('userSponsor').value;
    const sponsorId = sponsorValue ? parseInt(sponsorValue) : null;

    // Build request data
    const data = {
        first_name: document.getElementById('userFirstName').value.trim(),
        last_name: document.getElementById('userLastName').value.trim(),
        email: document.getElementById('userEmail').value.trim().toLowerCase(),
        country: document.getElementById('userCountry').value.trim() || 'USA',
        role: document.getElementById('userRole').value,
        // confirmed: REMOVED - can only be changed through /confirm/accept or /confirm/decline endpoints
        is_active: document.getElementById('userActive').checked,
        sponsor_id: sponsorId
    };

    // Include password if editing and password field has a value
    if (isEdit) {
        const password = document.getElementById('userPandasPassword').value.trim();
        if (password) {
            data.pandas_password = password;
        }
    }

    // Validate required fields
    if (!data.first_name || !data.last_name || !data.email) {
        alert('Please fill in all required fields (First Name, Last Name, Email)');
        return;
    }

    // Validate email format
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(data.email)) {
        alert('Please enter a valid email address');
        return;
    }

    const btn = document.getElementById('saveUserBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Saving...';

    try {
        const url = isEdit ? `/api/admin/participants/${userId}` : '/api/admin/participants';
        const method = isEdit ? 'PUT' : 'POST';

        const response = await csrfFetch(url, {
            method: method,
            body: data
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to save invitee');
        }

        const result = await response.json();

        // Close modal and refresh data
        bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
        loadUsers(currentPage);
        loadStats();
        loadSponsors();

        // Show success message with credentials for new users
        if (!isEdit && result.pandas_username && result.pandas_password) {
            alert(`Invitee created successfully!\n\nLogin Credentials:\nUsername: ${result.pandas_username}\nPassword: ${result.pandas_password}\n\nPlease save these credentials.`);
        } else {
            alert(isEdit ? 'Invitee updated successfully' : 'Invitee created successfully');
        }

    } catch (error) {
        console.error('Error saving invitee:', error);
        alert(error.message || 'Failed to save invitee. Please try again.');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i data-feather="save" class="me-1"></i> Save Invitee';
        feather.replace();
    }
}

window.resetUserPassword = async function() {
    const userId = document.getElementById('userId').value;
    if (!userId) return;

    if (!confirm('Generate a new password for this invitee?')) return;

    try {
        const response = await csrfFetch(`/api/admin/participants/${userId}/reset-password?send_email=false`, {
            method: 'POST'
        });

        const result = await response.json();
        document.getElementById('userPandasPassword').value = result.new_password || '';
        alert('Password reset successfully. New password: ' + result.new_password);
    } catch (error) {
        console.error('Error resetting password:', error);
        alert('Failed to reset password');
    }
}

window.copyUsername = function() {
    const username = document.getElementById('userPandasUsername').value;
    if (!username) {
        alert('No username to copy');
        return;
    }

    navigator.clipboard.writeText(username).then(() => {
        alert('Username copied to clipboard');
    }).catch(err => {
        console.error('Failed to copy username:', err);
        alert('Failed to copy username');
    });
}

window.copyPassword = function() {
    const password = document.getElementById('userPandasPassword').value;
    if (!password) {
        alert('No password to copy');
        return;
    }

    navigator.clipboard.writeText(password).then(() => {
        alert('Password copied to clipboard');
    }).catch(err => {
        console.error('Failed to copy password:', err);
        alert('Failed to copy password');
    });
}

// =============================================================================
// Role Management
// =============================================================================
window.openRoleModal = function(userId, userName, currentRole) {
    document.getElementById('roleUserId').value = userId;
    document.getElementById('roleUserName').textContent = userName;
    document.getElementById('newRole').value = currentRole;

    new bootstrap.Modal(document.getElementById('roleModal')).show();
    feather.replace();
}

window.saveRoleChange = async function() {
    const userId = document.getElementById('roleUserId').value;
    const newRole = document.getElementById('newRole').value;

    try {
        const response = await csrfFetch(`/api/admin/participants/${userId}/role`, {
            method: 'PUT',
            body: { participant_id: parseInt(userId), role: newRole }
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to change role');
        }

        bootstrap.Modal.getInstance(document.getElementById('roleModal')).hide();
        loadUsers(currentPage);
        loadStats();
        loadSponsors();

        alert('Role updated successfully');

    } catch (error) {
        console.error('Error changing role:', error);
        alert(error.message || 'Failed to change role');
    }
}

// =============================================================================
// Delete User
// =============================================================================
window.openDeleteModal = function(userId, userName) {
    document.getElementById('deleteUserId').value = userId;
    document.getElementById('deleteUserName').textContent = userName;

    new bootstrap.Modal(document.getElementById('deleteModal')).show();
    feather.replace();
}

window.confirmDelete = async function() {
    const userId = document.getElementById('deleteUserId').value;

    try {
        const response = await csrfFetch(`/api/admin/participants/${userId}`, {
            method: 'DELETE'
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to delete user');
        }

        bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
        loadUsers(currentPage);
        loadStats();

        alert('User deleted successfully');

    } catch (error) {
        console.error('Error deleting user:', error);
        alert(error.message || 'Failed to delete user');
    }
}

// =============================================================================
// Bulk Actions
// =============================================================================
window.toggleSelectAll = function(checkbox) {
    const checkboxes = document.querySelectorAll('#usersBody .user-checkbox');
    checkboxes.forEach(cb => {
        cb.checked = checkbox.checked;
        if (checkbox.checked) {
            selectedUsers.add(parseInt(cb.value));
        } else {
            selectedUsers.delete(parseInt(cb.value));
        }
    });
    updateBulkActionsButton();
}

window.toggleUserSelection = function(userId) {
    if (selectedUsers.has(userId)) {
        selectedUsers.delete(userId);
    } else {
        selectedUsers.add(userId);
    }
    updateBulkActionsButton();
}

function updateBulkActionsButton() {
    const btn = document.getElementById('bulkActionsBtn');
    btn.disabled = selectedUsers.size === 0;
}

window.bulkAction = async function(action) {
    if (selectedUsers.size === 0) return;

    const ids = Array.from(selectedUsers);
    const actionText = action === 'activate' ? 'activate' : action === 'deactivate' ? 'deactivate' : 'delete';

    if (!confirm(`Are you sure you want to ${actionText} ${ids.length} user(s)?`)) return;

    try {
        if (action === 'delete') {
            // Delete one by one
            for (const id of ids) {
                await csrfFetch(`/api/admin/participants/${id}`, {
                    method: 'DELETE'
                });
            }
        } else {
            await csrfFetch('/api/admin/participants/bulk', {
                method: 'POST',
                body: {
                    action: action,
                    participant_ids: ids
                }
            });
        }

        selectedUsers.clear();
        document.getElementById('selectAllUsers').checked = false;
        updateBulkActionsButton();
        loadUsers(currentPage);
        loadStats();

        alert(`Successfully ${actionText}d ${ids.length} user(s)`);

    } catch (error) {
        console.error('Error performing bulk action:', error);
        alert('Failed to perform bulk action');
    }
}

// =============================================================================
// Utilities
// =============================================================================
window.clearFilters = function() {
    document.getElementById('userSearch').value = '';
    document.getElementById('userRoleFilter').value = '';
    document.getElementById('userStatusFilter').value = '';
    document.getElementById('userConfirmedFilter').value = '';
    document.getElementById('userEmailStatusFilter').value = '';
    document.getElementById('userCountryFilter').value = '';
    loadUsers(1);
}

window.sortTable = function(field) {
    // Toggle sort order if clicking the same field, otherwise default to desc
    if (sortBy === field) {
        sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
    } else {
        sortBy = field;
        sortOrder = 'desc';
    }

    updateSortIndicator();
    loadUsers(currentPage);
}

function updateSortIndicator() {
    const indicator = document.getElementById('sortIndicator');
    if (sortBy === 'confirmed_at') {
        indicator.innerHTML = sortOrder === 'asc' ? ' ‚ñ≤' : ' ‚ñº';
    } else {
        indicator.innerHTML = '';
    }
}

window.resendInvitation = async function(userId, email) {
    if (!confirm(`Resend invitation email to ${email}?`)) {
        return;
    }

    try {
        const response = await csrfFetch(`/api/admin/participants/${userId}/resend-invitation`, {
            method: 'POST'
        });

        if (response.ok) {
            const data = await response.json();
            showToast(data.message || 'Invitation email queued successfully', 'success');
            loadUsers(currentPage);
        } else {
            const data = await response.json();
            showToast(data.detail || 'Failed to resend invitation', 'danger');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Failed to resend invitation', 'danger');
    }
};

window.bulkResendInvitation = async function() {
    if (selectedUsers.size === 0) return;

    const confirmMsg = `Resend invitation emails to ${selectedUsers.size} user(s)?\n\n` +
                      `This will:\n` +
                      `- Generate new confirmation codes\n` +
                      `- Create EventParticipation records if needed\n` +
                      `- Queue invitation emails`;

    if (!confirm(confirmMsg)) {
        return;
    }

    try {
        let successCount = 0;
        let failCount = 0;
        const failedEmails = [];

        for (const userId of selectedUsers) {
            try {
                const response = await csrfFetch(`/api/admin/participants/${userId}/resend-invitation`, {
                    method: 'POST'
                });

                if (response.ok) {
                    successCount++;
                } else {
                    failCount++;
                    const data = await response.json();
                    failedEmails.push(data.detail || `ID ${userId}`);
                }
            } catch (error) {
                failCount++;
                failedEmails.push(`ID ${userId}: ${error.message}`);
            }
        }

        let message = `Successfully queued ${successCount} invitation(s)`;
        if (failCount > 0) {
            message += `\n\nFailed: ${failCount}\n${failedEmails.join('\n')}`;
        }

        showToast(message, failCount > 0 ? 'warning' : 'success');
        loadUsers(currentPage);
        selectedUsers.clear();
        updateBulkActionsButton();
    } catch (error) {
        console.error('Error:', error);
        showToast('Bulk resend operation failed', 'danger');
    }
};

window.resetWorkflow = async function(userId, email) {
    if (!confirm(
        `Reset workflow state for ${email}?\n\n` +
        `This will:\n` +
        `‚Ä¢ Reset confirmation status to UNKNOWN\n` +
        `‚Ä¢ Clear all reminder timestamps\n` +
        `‚Ä¢ Clear password email timestamp\n` +
        `‚Ä¢ Delete EventParticipation for current event\n` +
        `‚Ä¢ Generate new confirmation code\n\n` +
        `Use this to re-test invitation flows or re-invite users.`
    )) {
        return;
    }

    try {
        const response = await csrfFetch(`/api/admin/participants/${userId}/reset-workflow`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                reset_event_participation: true
            })
        });

        if (!response.ok) {
            const data = await response.json();
            showToast(data.detail || 'Failed to reset workflow state', 'danger');
            return;
        }

        const data = await response.json();
        showToast(data.message || 'Workflow state reset successfully', 'success');
        loadUsers(currentPage); // Reload the current page
    } catch (error) {
        console.error('Error resetting workflow:', error);
        showToast('Network error: Failed to reset workflow state', 'danger');
    }
};

window.bulkResetWorkflow = async function() {
    if (selectedUsers.size === 0) {
        showToast('Please select users to reset', 'warning');
        return;
    }

    const count = selectedUsers.size;
    if (!confirm(
        `Reset workflow state for ${count} selected user(s)?\n\n` +
        `This will:\n` +
        `‚Ä¢ Reset confirmation status to UNKNOWN\n` +
        `‚Ä¢ Clear all reminder timestamps\n` +
        `‚Ä¢ Clear password email timestamp\n` +
        `‚Ä¢ Delete EventParticipation for current event\n` +
        `‚Ä¢ Generate new confirmation codes\n\n` +
        `Use this to re-test invitation flows or re-invite users.`
    )) {
        return;
    }

    try {
        let successCount = 0;
        let failCount = 0;
        const failedEmails = [];

        // Process each selected user
        for (const userId of selectedUsers) {
            try {
                const response = await csrfFetch(`/api/admin/participants/${userId}/reset-workflow`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        reset_event_participation: true
                    })
                });

                if (response.ok) {
                    successCount++;
                } else {
                    failCount++;
                    const data = await response.json();
                    failedEmails.push(data.detail || `ID ${userId}`);
                }
            } catch (error) {
                failCount++;
                failedEmails.push(`ID ${userId}: ${error.message}`);
            }
        }

        let message = `Successfully reset ${successCount} user(s)`;
        if (failCount > 0) {
            message += `\n\nFailed: ${failCount}\n${failedEmails.join('\n')}`;
        }

        showToast(message, failCount > 0 ? 'warning' : 'success');
        loadUsers(currentPage);
        selectedUsers.clear();
        updateBulkActionsButton();
    } catch (error) {
        console.error('Error:', error);
        showToast('Bulk reset operation failed', 'danger');
    }
};

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ===============================================
// Assign Action Functions
// ===============================================

window.showAssignActionModal = async function() {
    document.getElementById('actionTargetCount').textContent = selectedUsers.size;

    // Load email templates
    try {
        const response = await csrfFetch('/api/email/templates');
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const templates = await response.json();
        console.log('Loaded templates:', templates);

        const templateSelect = document.getElementById('actionEmailTemplate');
        templateSelect.innerHTML = '<option value="">Use default action notification</option>';

        // Filter to only SendGrid templates
        const sendgridTemplates = templates.filter(t => t.sendgrid_template_id);
        console.log('SendGrid templates:', sendgridTemplates);

        if (sendgridTemplates.length === 0) {
            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'No SendGrid templates available - sync templates first';
            option.disabled = true;
            templateSelect.appendChild(option);
        } else {
            sendgridTemplates.forEach(template => {
                const option = document.createElement('option');
                option.value = template.id;
                option.textContent = template.display_name || template.name;
                templateSelect.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Failed to load templates:', error);
        const templateSelect = document.getElementById('actionEmailTemplate');
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'Error loading templates';
        option.disabled = true;
        templateSelect.appendChild(option);
    }

    const modal = new bootstrap.Modal(document.getElementById('assignActionModal'));
    modal.show();
    // Reinitialize feather icons after modal opens
    setTimeout(() => feather.replace(), 100);
};

window.submitAssignAction = async function() {
    const actionType = document.getElementById('actionType').value;
    const title = document.getElementById('actionTitle').value;
    const description = document.getElementById('actionDescription').value;
    const deadline = document.getElementById('actionDeadline').value;
    const sendNotification = document.getElementById('sendNotification').checked;
    const emailTemplateId = document.getElementById('actionEmailTemplate').value;

    if (!title) {
        showError('assignActionError', 'Title is required');
        return;
    }

    try {
        const response = await csrfFetch('/api/admin/actions/bulk', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                action_type: actionType,
                title: title,
                description: description || null,
                deadline: deadline || null,
                user_ids: Array.from(selectedUsers),
                send_notification: sendNotification,
                email_template_id: emailTemplateId ? parseInt(emailTemplateId) : null
            })
        });

        if (response.ok) {
            const result = await response.json();
            showToast(`Assigned action to ${result.actions_created} participants`, 'success');
            bootstrap.Modal.getInstance(document.getElementById('assignActionModal')).hide();
            document.getElementById('assignActionForm').reset();
            document.getElementById('assignActionError').classList.add('d-none');
        } else {
            const error = await response.json();
            showError('assignActionError', error.detail || 'Failed to assign action');
        }
    } catch (error) {
        console.error('Failed to assign action:', error);
        showError('assignActionError', 'Failed to assign action');
    }
};

function showError(elementId, message) {
    const errorElement = document.getElementById(elementId);
    errorElement.textContent = message;
    errorElement.classList.remove('d-none');
}

})(); // End IIFE
</script>
{% endblock %}
