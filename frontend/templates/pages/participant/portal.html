{% extends "layouts/base.html" %}

{% block title %}Participant Portal{% endblock %}

{% block extra_css %}
<style>
    .vpn-cell {
        cursor: pointer;
        user-select: text;
        border-bottom: 1px dotted #dee2e6;
    }
    .vpn-cell:hover {
        background-color: #f8f9fa;
    }
    .popover-body {
        user-select: text;
        word-break: break-all;
        font-family: 'Courier New', monospace;
        font-size: 0.875rem;
    }
    @keyframes rotate {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    .rotating {
        animation: rotate 1s linear infinite;
        display: inline-block;
    }
</style>
{% endblock %}

{% block body_class %}bg-light{% endblock %}

{% block body %}
<!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-dark" style="background-color: #212529;">
    <div class="container">
        <a class="navbar-brand" href="/portal">
            <img src="/static/img/cyberx-star-logo.svg" alt="CyberX" style="width: 28px; height: 28px; vertical-align: middle;" class="me-2">CyberX Portal
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle text-white" href="#" role="button" data-bs-toggle="dropdown">
                        <i data-feather="user" class="me-1"></i>
                        {{ current_user.first_name }} {{ current_user.last_name }}
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="/profile"><i data-feather="settings" class="me-2"></i>Settings</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <button class="dropdown-item" id="themeToggle" onclick="toggleTheme()" type="button">
                                <i data-feather="moon" class="me-2" id="themeIcon"></i>
                                <span id="themeLabel">Dark Mode</span>
                            </button>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="logout()"><i data-feather="log-out" class="me-2"></i>Logout</a></li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<!-- Main Content -->
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Welcome Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-body text-center py-5">
                    <div class="display-1 mb-3">
                        <i data-feather="shield" class="text-primary" style="width: 64px; height: 64px;"></i>
                    </div>
                    <h2>Welcome to CyberX, {{ current_user.first_name }}!</h2>
                    <p class="text-muted mb-0">Your participant dashboard for the CyberX event</p>
                </div>
            </div>

            <!-- Sponsor Management Card (Sponsors Only) -->
            {% if current_user.role == 'sponsor' %}
            <div class="card shadow-sm mb-4 border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i data-feather="users" class="me-2"></i>Sponsor Management</h5>
                </div>
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h6 class="mb-2">Manage Your Invitees</h6>
                            <p class="text-muted mb-0">
                                As a sponsor, you can manage your invitees, add new participants, reset passwords, and track their status.
                            </p>
                        </div>
                        <div class="col-md-4 text-md-end mt-3 mt-md-0">
                            <a href="/sponsor/invitees" class="btn btn-primary btn-lg" target="_blank" rel="noopener noreferrer">
                                <i data-feather="external-link" class="me-2"></i>
                                Manage Invitees
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Event Information Card -->
            <div class="card shadow-sm mb-4" id="eventInfoCard">
                <div class="card-header">
                    <h5 class="mb-0"><i data-feather="calendar" class="me-2"></i>Current Event</h5>
                </div>
                <div class="card-body">
                    <div id="eventLoadingState" class="text-center py-3">
                        <div class="spinner-border spinner-border-sm text-primary"></div>
                        <span class="ms-2 text-muted">Loading event information...</span>
                    </div>
                    <div id="eventDetailsState" class="d-none">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        <div class="rounded-circle bg-info bg-opacity-10 p-3">
                                            <i data-feather="calendar" class="text-info"></i>
                                        </div>
                                    </div>
                                    <div class="ms-3">
                                        <div class="small text-muted">Event Name</div>
                                        <div class="fw-bold" id="eventName">-</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        <div class="rounded-circle bg-success bg-opacity-10 p-3">
                                            <i data-feather="clock" class="text-success"></i>
                                        </div>
                                    </div>
                                    <div class="ms-3">
                                        <div class="small text-muted">Event Dates</div>
                                        <div class="fw-bold" id="eventDates">-</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- SSH Key Download -->
                        <div id="sshKeySection" class="mt-3 pt-3 border-top" style="display: none;">
                            <div class="alert alert-info mb-0">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div>
                                        <i data-feather="key" class="me-2"></i>
                                        <strong>SSH Key Available</strong>
                                        <p class="mb-0 mt-1 small">Download the SSH private key to access your instances.</p>
                                    </div>
                                    <a href="/portal/ssh-key" class="btn btn-sm btn-primary">
                                        <i data-feather="download" class="me-1"></i>Download
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="eventErrorState" class="d-none">
                        <div class="alert alert-warning mb-0">
                            <i data-feather="info" class="me-2"></i>
                            <span>No active event found. Please contact your administrator.</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i data-feather="user" class="me-2"></i>Your Status</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <div class="rounded-circle bg-primary bg-opacity-10 p-3">
                                        <i data-feather="mail" class="text-primary"></i>
                                    </div>
                                </div>
                                <div class="ms-3">
                                    <div class="small text-muted">Email</div>
                                    <div class="fw-bold">{{ current_user.email }}</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <div class="rounded-circle bg-success bg-opacity-10 p-3">
                                        <i data-feather="check-circle" class="text-success"></i>
                                    </div>
                                </div>
                                <div class="ms-3">
                                    <div class="small text-muted">Confirmation Status</div>
                                    <div class="fw-bold">
                                        {% if current_user.confirmed == 'YES' %}
                                        <span class="text-success">Confirmed</span>
                                        {% elif current_user.confirmed == 'NO' %}
                                        <span class="text-danger">Not Confirmed</span>
                                        {% else %}
                                        <span class="text-warning">Pending</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% if current_user.country %}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <div class="rounded-circle bg-info bg-opacity-10 p-3">
                                        <i data-feather="globe" class="text-info"></i>
                                    </div>
                                </div>
                                <div class="ms-3">
                                    <div class="small text-muted">Country</div>
                                    <div class="fw-bold">
                                        {% if current_user.country == 'United States' %}
                                        üá∫üá∏ United States
                                        {% elif current_user.country == 'Canada' %}
                                        üá®üá¶ Canada
                                        {% elif current_user.country == 'United Kingdom' %}
                                        üá¨üáß United Kingdom
                                        {% else %}
                                        üåê {{ current_user.country }}
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% if current_user.sponsor %}
                    <div class="row">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <div class="rounded-circle bg-info bg-opacity-10 p-3">
                                        <i data-feather="user-check" class="text-info"></i>
                                    </div>
                                </div>
                                <div class="ms-3">
                                    <div class="small text-muted">Sponsored By</div>
                                    <div class="fw-bold">{{ current_user.sponsor.first_name }} {{ current_user.sponsor.last_name }}</div>
                                    <div class="small text-muted">{{ current_user.sponsor.email }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Authentication Information Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i data-feather="key" class="me-2"></i>Authentication</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info mb-0">
                        <i data-feather="info" class="me-2"></i>
                        <div>
                            <strong>Single Sign-On (SSO) Enabled</strong>
                            <p class="mb-2 mt-2">Your website login password is automatically synchronized with Keycloak, which provides authentication for all in-game services and resources.</p>
                            <p class="mb-0">
                                <i data-feather="settings" class="me-1" style="width: 14px; height: 14px;"></i>
                                To change your password, visit the <a href="/profile" class="alert-link">Settings</a> page.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VPN Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i data-feather="shield" class="me-2"></i>VPN Credentials</h5>
                    <span class="badge bg-primary" id="vpnCountBadge">-</span>
                </div>
                <div class="card-body" id="vpnContent">
                    <div class="text-center py-4">
                        <div class="spinner-border spinner-border-sm me-2"></div>
                        Loading VPN status...
                    </div>
                </div>
            </div>

            <!-- Request VPN Card -->
            <div class="card shadow-sm mb-4" id="requestVPNCard">
                <div class="card-header">
                    <h5 class="mb-0"><i data-feather="plus-circle" class="me-2"></i>Request VPN Credentials</h5>
                </div>
                <div class="card-body">
                    <div id="vpnRequestContent">
                        <p class="text-muted mb-3">Need more VPN credentials? You can request up to 25 at a time.</p>
                        <div class="row align-items-end">
                            <div class="col-md-4 mb-3 mb-md-0">
                                <label class="form-label">Number of VPNs to Request</label>
                                <input type="number" class="form-control" id="requestCount" value="1" min="1" max="25">
                            </div>
                            <div class="col-md-4 mb-3 mb-md-0">
                                <label class="form-label">Available VPNs</label>
                                <div class="form-control bg-light" id="availableCount">Loading...</div>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-primary w-100" onclick="requestVPNs()" id="requestBtn">
                                    <i data-feather="download-cloud" class="me-2"></i>Request VPNs
                                </button>
                            </div>
                        </div>
                        <div id="requestResult" class="mt-3" style="display: none;"></div>
                    </div>
                    <div id="vpnRequestDisabled" class="d-none">
                        <div class="alert alert-warning mb-0">
                            <i data-feather="info" class="me-2"></i>
                            <strong>VPN Requests Not Available</strong>
                            <p class="mb-0 mt-2">VPN access has not been enabled for this event yet. Please check back closer to the event date.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Instance Provisioning Section -->
            <div id="instanceProvisioningSection" style="display: none;">
                <!-- Available Templates Card -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i data-feather="layout" class="me-2"></i>Available Instance Templates</h5>
                    </div>
                    <div class="card-body">
                        <div id="templatesLoading" class="text-center py-4">
                            <div class="spinner-border spinner-border-sm me-2"></div>
                            Loading templates...
                        </div>
                        <div id="templatesContent" class="d-none">
                            <div id="templatesList" class="row">
                                <!-- Templates loaded dynamically -->
                            </div>
                        </div>
                        <div id="templatesEmpty" class="d-none">
                            <div class="alert alert-info mb-0">
                                <i data-feather="info" class="me-2"></i>
                                No instance templates are currently available. Please check back closer to the event start date.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- My Instances Card -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center gap-3 flex-grow-1">
                                <h5 class="mb-0"><i data-feather="server" class="me-2"></i>My Instances</h5>
                                <div id="providerStatsInfo" class="small text-muted">
                                    <!-- Provider stats and last sync time loaded here -->
                                </div>
                            </div>
                            <button class="btn btn-sm btn-outline-primary ms-3" onclick="refreshInstances()">
                                <i data-feather="refresh-cw" class="me-1"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="instancesLoading" class="text-center py-4">
                            <div class="spinner-border spinner-border-sm me-2"></div>
                            Loading instances...
                        </div>
                        <div id="instancesContent" class="d-none">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Template</th>
                                            <th>Status</th>
                                            <th>IP</th>
                                            <th>VPN IP</th>
                                            <th>Visibility</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="instancesTableBody">
                                        <!-- Instances loaded dynamically -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div id="instancesEmpty" class="d-none">
                            <div class="alert alert-info mb-0">
                                <i data-feather="info" class="me-2"></i>
                                You haven't provisioned any instances yet. Use the templates above to get started!
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Provision Instance Modal -->
            <div class="modal fade" id="provisionModal" tabindex="-1" aria-labelledby="provisionModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="provisionModalLabel">Provision Instance</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="provisionForm">
                                <input type="hidden" id="provisionTemplateId">

                                <div class="mb-3">
                                    <label class="form-label">Instance Name <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="provisionName" required>
                                    <div class="form-text">Choose a descriptive name for your instance</div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Visibility</label>
                                    <select class="form-select" id="provisionVisibility">
                                        <option value="private" selected>Private (only I can see it)</option>
                                        <option value="public">Public (visible to all participants)</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Notes</label>
                                    <textarea class="form-control" id="provisionNotes" rows="3"
                                              placeholder="Document usage, purpose, or instructions..."></textarea>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="provisionInstance()">Provision</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Edit Instance Modal -->
            <div class="modal fade" id="editInstanceModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Edit Instance</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="editInstanceForm">
                                <input type="hidden" id="editInstanceId">
                                <div class="mb-3">
                                    <label class="form-label">Instance Name</label>
                                    <input type="text" class="form-control" id="editInstanceName" readonly>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Visibility</label>
                                    <select class="form-select" id="editInstanceVisibility">
                                        <option value="private">Private (only I can see it)</option>
                                        <option value="public">Public (visible to all participants)</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Notes</label>
                                    <textarea class="form-control" id="editInstanceNotes" rows="3"
                                              placeholder="Document usage, purpose, or instructions..."></textarea>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="saveInstanceChanges()">Save Changes</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Help Card -->
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0"><i data-feather="help-circle" class="me-2"></i>Need Help?</h5>
                </div>
                <div class="card-body">
                    <p class="mb-2">If you have any questions or issues, please contact:</p>
                    <ul class="mb-0">
                        {% if current_user.sponsor %}
                        <li><strong>Your Sponsor:</strong> {{ current_user.sponsor.first_name }} {{ current_user.sponsor.last_name }} (<a href="mailto:{{ current_user.sponsor.email }}">{{ current_user.sponsor.email }}</a>)</li>
                        {% else %}
                        <li>Your sponsor or team lead</li>
                        {% endif %}
                        <li>The CyberX support team</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Footer -->
<footer class="bg-dark text-white-50 py-3 mt-auto">
    <div class="container">
        <div class="d-flex align-items-center justify-content-between">
            <small>Copyright &copy; CyberX Red Team {{ now.year if now else '2026' }}</small>
            <small>{{ app_version }}</small>
        </div>
    </div>
</footer>
{% endblock %}

{% block extra_js %}
<script>
async function logout() {
    try {
        const response = await csrfFetch('/api/auth/logout', {
            method: 'POST'
        });
        if (response.ok) {
            window.location.href = '/login';
        }
    } catch (error) {
        console.error('Logout failed:', error);
    }
}

let currentEvent = null;  // Store current event data globally

// Current user info from server
const currentUser = {
    id: {{ current_user.id }},
    role: '{{ current_user.role }}',
    isSponsor: {{ 'true' if current_user.role == 'sponsor' or current_user.is_sponsor else 'false' }}
};

async function loadEventInfo() {
    var loadingState = document.getElementById('eventLoadingState');
    var detailsState = document.getElementById('eventDetailsState');
    var errorState = document.getElementById('eventErrorState');

    try {
        var response = await csrfFetch('/api/events/active');

        if (response.ok) {
            var data = await response.json();

            // Check if there's an active event
            if (!data.active || !data.event) {
                loadingState.classList.add('d-none');
                errorState.classList.remove('d-none');
                refreshFeatherIcons();
                return;
            }

            currentEvent = data.event;

            // Update event details
            document.getElementById('eventName').textContent = currentEvent.name;

            // Format dates
            if (currentEvent.start_date && currentEvent.end_date) {
                var startDate = formatDate(currentEvent.start_date);
                var endDate = formatDate(currentEvent.end_date);
                document.getElementById('eventDates').textContent = `${startDate} - ${endDate}`;
            } else {
                document.getElementById('eventDates').textContent = 'Dates TBD';
            }

            // Show SSH key section if available
            var sshKeySection = document.getElementById('sshKeySection');
            if (currentEvent.ssh_public_key) {
                sshKeySection.style.display = 'block';
            } else {
                sshKeySection.style.display = 'none';
            }

            loadingState.classList.add('d-none');
            detailsState.classList.remove('d-none');
        } else {
            throw new Error('Failed to load event information');
        }

        refreshFeatherIcons();

    } catch (error) {
        console.error('Error loading event info:', error);
        loadingState.classList.add('d-none');
        errorState.classList.remove('d-none');
        refreshFeatherIcons();
    }
}

async function loadVPNStatus() {
    var content = document.getElementById('vpnContent');
    var badge = document.getElementById('vpnCountBadge');

    try {
        // Check if VPN is available for current event
        const vpnAllowed = currentEvent && (currentEvent.vpn_available || (currentEvent.test_mode && currentUser.isSponsor));

        if (!vpnAllowed) {
            content.innerHTML = `
                <div class="alert alert-warning mb-0">
                    <i data-feather="info" class="me-2"></i>
                    <strong>VPN Access Not Yet Available</strong>
                    <p class="mb-0 mt-2">VPN credentials for ${currentEvent ? currentEvent.name : 'this event'} will be made available closer to the event start date. Please check back later.</p>
                </div>
            `;
            badge.textContent = '0';
            refreshFeatherIcons();
            return;
        }

        var response = await csrfFetch('/api/vpn/my-credentials');

        if (response.ok) {
            var data = await response.json();
            badge.textContent = data.total;

            if (data.total === 0) {
                const testModeBadge = currentEvent.test_mode && !currentEvent.vpn_available && currentUser.isSponsor ?
                    '<span class="badge bg-warning text-dark ms-2"><i data-feather="zap" class="me-1" style="width:12px;height:12px;"></i>Test Mode</span>' : '';
                content.innerHTML = `
                    <div class="alert alert-info mb-0">
                        <i data-feather="info" class="me-2"></i>
                        You don't have any VPN credentials yet. Use the form below to request VPN access.${testModeBadge}
                    </div>
                `;
            } else {
                const testModeBadge = currentEvent.test_mode && !currentEvent.vpn_available && currentUser.isSponsor ?
                    '<span class="badge bg-warning text-dark ms-2"><i data-feather="zap" style="width:12px;height:12px;"></i> Test Mode</span>' : '';

                // Get naming pattern from API (default pattern if fetch fails)
                let namingPattern = 'simnet_{ipv4_address}.conf';
                try {
                    const patternResponse = await csrfFetch('/api/vpn/naming-pattern');
                    if (patternResponse.ok) {
                        const patternData = await patternResponse.json();
                        namingPattern = patternData.pattern;
                    }
                } catch (error) {
                    console.error('Error fetching naming pattern:', error);
                }
                const namingParam = `?naming_pattern=${encodeURIComponent(namingPattern)}`;

                // Fetch request batches for bulk download options
                let batchesHTML = '';
                if (data.total > 1) {
                    try {
                        const batchesResponse = await csrfFetch('/api/vpn/my-request-batches');
                        if (batchesResponse.ok) {
                            const batchesData = await batchesResponse.json();
                            if (batchesData.batches && batchesData.batches.length > 0) {
                                batchesHTML = `
                                    <div class="btn-group me-2">
                                        <a href="/api/vpn/my-configs/download${namingParam}" class="btn btn-sm btn-primary">
                                            <i data-feather="download" class="me-1"></i>Bulk Download
                                        </a>
                                        <button type="button" class="btn btn-sm btn-primary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
                                            <span class="visually-hidden">Toggle Dropdown</span>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><h6 class="dropdown-header">Download Options</h6></li>
                                            <li><a class="dropdown-item" href="/api/vpn/my-configs/download${namingParam}">
                                                <i data-feather="download" class="me-2"></i>All Credentials (${data.total})
                                            </a></li>
                                            <li><hr class="dropdown-divider"></li>
                                            ${batchesData.batches.map((batch, index) => {
                                                const requestDate = new Date(batch.requested_at).toLocaleString('en-US', {
                                                    month: 'short',
                                                    day: 'numeric',
                                                    hour: 'numeric',
                                                    minute: '2-digit'
                                                });
                                                const batchIdShort = batch.batch_id.substring(0, 8);
                                                return `<li><a class="dropdown-item" href="/api/vpn/download-batch/${batch.batch_id}${namingParam}">
                                                    <i data-feather="package" class="me-2"></i>${batchIdShort} (${batch.count}) - ${requestDate}
                                                </a></li>`;
                                            }).join('')}
                                        </ul>
                                    </div>
                                `;
                            } else {
                                // Fallback if no batches (legacy VPNs without batch_id)
                                batchesHTML = `<a href="/api/vpn/my-configs/download${namingParam}" class="btn btn-sm btn-primary me-2">
                                    <i data-feather="download" class="me-1"></i>Download All (ZIP)
                                </a>`;
                            }
                        } else {
                            // Fallback if batches endpoint fails
                            batchesHTML = `<a href="/api/vpn/my-configs/download${namingParam}" class="btn btn-sm btn-primary me-2">
                                <i data-feather="download" class="me-1"></i>Download All (ZIP)
                            </a>`;
                        }
                    } catch (error) {
                        console.error('Error fetching batches:', error);
                        // Fallback on error
                        batchesHTML = `<a href="/api/vpn/my-configs/download${namingParam}" class="btn btn-sm btn-primary me-2">
                            <i data-feather="download" class="me-1"></i>Download All (ZIP)
                        </a>`;
                    }
                }

                var html = `
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="text-muted">You have ${data.total} VPN credential${data.total > 1 ? 's' : ''}${testModeBadge}</span>
                        <div>
                            ${batchesHTML}
                            <button class="btn btn-sm btn-outline-secondary" onclick="showVPNInstructions()">
                                <i data-feather="help-circle" class="me-1"></i>Setup Guide
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>IPv4 Address</th>
                                    <th>Endpoint</th>
                                    <th>SHA256 Hash</th>
                                    <th>Request ID</th>
                                    <th>Assigned</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                data.credentials.forEach((vpn, index) => {
                    const hashDisplay = vpn.file_hash ? vpn.file_hash.substring(0, 8) + '...' : '-';
                    const batchIdDisplay = vpn.request_batch_id ? vpn.request_batch_id.substring(0, 8) : '-';
                    html += `
                        <tr>
                            <td>${index + 1}</td>
                            <td><code class="vpn-cell" tabindex="0" data-bs-toggle="popover" data-bs-trigger="click" data-bs-content="${vpn.ipv4_address || 'N/A'}">${vpn.ipv4_address || '-'}</code></td>
                            <td><code class="vpn-cell" tabindex="0" data-bs-toggle="popover" data-bs-trigger="click" data-bs-content="${vpn.endpoint || 'N/A'}">${vpn.endpoint}</code></td>
                            <td><code class="small text-muted vpn-cell" tabindex="0" data-bs-toggle="popover" data-bs-trigger="click" data-bs-content="${vpn.file_hash || 'No hash'}">${hashDisplay}</code></td>
                            <td><code class="small text-muted vpn-cell" tabindex="0" data-bs-toggle="popover" data-bs-trigger="click" data-bs-content="${vpn.request_batch_id || 'No batch ID'}">${batchIdDisplay}</code></td>
                            <td tabindex="0" data-bs-toggle="popover" data-bs-trigger="click" data-bs-content="${vpn.assigned_at ? new Date(vpn.assigned_at).toLocaleString() : 'N/A'}">${formatDateTime(vpn.assigned_at, {hideSeconds: true})}</td>
                            <td class="text-end">
                                <a href="/api/vpn/my-config/download?vpn_id=${vpn.id}" class="btn btn-sm btn-outline-primary" title="Download config">
                                    <i data-feather="download"></i>
                                </a>
                            </td>
                        </tr>
                    `;
                });

                html += '</tbody></table></div>';
                content.innerHTML = html;

                // Initialize popovers for VPN cells and store instances
                const popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
                const popoverInstances = popoverTriggerList.map(function (popoverTriggerEl) {
                    return new bootstrap.Popover(popoverTriggerEl, {
                        html: true,
                        sanitize: false
                    });
                });

                // Close popovers when clicking outside
                document.addEventListener('click', function(event) {
                    const isClickInsidePopover = event.target.closest('.popover');
                    const isClickOnTrigger = event.target.closest('[data-bs-toggle="popover"]');

                    if (!isClickInsidePopover && !isClickOnTrigger) {
                        popoverInstances.forEach(function(popover) {
                            popover.hide();
                        });
                    }
                });
            }
        } else if (response.status === 401) {
            window.location.href = '/login';
            return;
        } else {
            throw new Error('Failed to load VPN status');
        }

        refreshFeatherIcons();

    } catch (error) {
        console.error('Error:', error);
        content.innerHTML = '<div class="alert alert-danger mb-0"><i data-feather="alert-circle" class="me-2"></i>Failed to load VPN status. Please refresh the page.</div>';
        refreshFeatherIcons();
    }
}

async function loadAvailableCount() {
    // Check if VPN is available for current event
    const vpnAllowed = currentEvent && (currentEvent.vpn_available || (currentEvent.test_mode && currentUser.isSponsor));

    if (!vpnAllowed) {
        // Hide the request form and show disabled message
        document.getElementById('vpnRequestContent').classList.add('d-none');
        document.getElementById('vpnRequestDisabled').classList.remove('d-none');
        refreshFeatherIcons();
        return;
    }

    // VPN is available, show the request form
    document.getElementById('vpnRequestContent').classList.remove('d-none');
    document.getElementById('vpnRequestDisabled').classList.add('d-none');

    try {
        var response = await csrfFetch('/api/vpn/available-count');
        if (response.ok) {
            var data = await response.json();
            document.getElementById('availableCount').textContent = data.available_count + ' available';
        }
    } catch (error) {
        console.error('Error loading available count:', error);
        document.getElementById('availableCount').textContent = 'Unknown';
    }
}

async function requestVPNs() {
    var count = parseInt(document.getElementById('requestCount').value);
    var btn = document.getElementById('requestBtn');
    var resultDiv = document.getElementById('requestResult');

    // Check if VPN is available
    const vpnAllowed = currentEvent && (currentEvent.vpn_available || (currentEvent.test_mode && currentUser.isSponsor));

    if (!vpnAllowed) {
        resultDiv.className = 'mt-3 alert alert-warning';
        resultDiv.innerHTML = '<i data-feather="info" class="me-2"></i>VPN access is not yet available for this event.';
        resultDiv.style.display = 'block';
        refreshFeatherIcons();
        return;
    }

    if (count < 1 || count > 25) {
        resultDiv.className = 'mt-3 alert alert-warning';
        resultDiv.innerHTML = 'Please enter a number between 1 and 25.';
        resultDiv.style.display = 'block';
        return;
    }

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Requesting...';

    try {
        var response = await csrfFetch('/api/vpn/request', {
            method: 'POST',
            body: { count: count }
        });

        var data = await response.json();

        if (response.ok && data.success) {
            resultDiv.className = 'mt-3 alert alert-success';
            resultDiv.innerHTML = `<i data-feather="check-circle" class="me-2"></i>${data.message} You now have ${data.total_vpns} VPN credential${data.total_vpns > 1 ? 's' : ''}.`;
            loadVPNStatus();
            loadAvailableCount();
        } else if (response.status === 429) {
            resultDiv.className = 'mt-3 alert alert-warning';
            resultDiv.innerHTML = '<i data-feather="clock" class="me-2"></i>Too many requests. Please wait a few minutes before requesting more VPNs.';
        } else {
            resultDiv.className = 'mt-3 alert alert-danger';
            resultDiv.innerHTML = '<i data-feather="alert-circle" class="me-2"></i>' + (data.detail || data.message || 'Failed to request VPNs');
        }

        resultDiv.style.display = 'block';
        refreshFeatherIcons();

    } catch (error) {
        console.error('Error:', error);
        resultDiv.className = 'mt-3 alert alert-danger';
        resultDiv.innerHTML = '<i data-feather="alert-circle" class="me-2"></i>Failed to request VPNs. Please try again.';
        resultDiv.style.display = 'block';
    }

    btn.disabled = false;
    btn.innerHTML = '<i data-feather="download-cloud" class="me-2"></i>Request VPNs';
    refreshFeatherIcons();
}

function refreshFeatherIcons() {
    if (typeof feather !== 'undefined') {
        feather.replace();
    }
}

function showVPNInstructions() {
    var modal = document.createElement('div');
    modal.className = 'modal fade show';
    modal.style.display = 'block';
    modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
    modal.innerHTML = '<div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">WireGuard Setup Instructions</h5><button type="button" class="btn-close" onclick="this.closest(\'.modal\').remove()"></button></div><div class="modal-body"><h6>1. Install WireGuard</h6><p>Download WireGuard from <a href="https://www.wireguard.com/install/" target="_blank" rel="noopener noreferrer">wireguard.com</a> for your operating system.</p><h6>2. Import Configuration</h6><ul><li><strong>Windows/Mac/Linux:</strong> Click "Import tunnel(s) from file" and select the downloaded .conf file</li><li><strong>Mobile:</strong> Use the QR code scanner or import the file</li></ul><h6>3. Connect</h6><p>Click "Activate" to connect to the VPN. You should see a connected status and your traffic will be routed through the CyberX network.</p><div class="alert alert-info"><i class="fas fa-info-circle me-2"></i><strong>Important:</strong> Only connect to the VPN during the event timeframe as specified by your team lead.</div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" onclick="this.closest(\'.modal\').remove()">Close</button></div></div></div>';
    document.body.appendChild(modal);
}

// Instance Provisioning Functions
let provisionModal;

async function loadAvailableTemplates() {
    const templatesLoading = document.getElementById('templatesLoading');
    const templatesContent = document.getElementById('templatesContent');
    const templatesEmpty = document.getElementById('templatesEmpty');
    const templatesList = document.getElementById('templatesList');

    try {
        const response = await csrfFetch('/api/participants/available-templates');

        if (response.ok) {
            const templates = await response.json();

            if (templates.length === 0) {
                templatesLoading.classList.add('d-none');
                templatesEmpty.classList.remove('d-none');
                return;
            }

            templatesList.innerHTML = templates.map(t => {
                return `
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-title">${t.name}</h6>
                                <p class="card-text small text-muted">${t.description || ''}</p>
                                <div class="small">
                                    <strong>Provider:</strong> ${t.provider}<br>
                                    <strong>Cloud-Init:</strong> ${t.cloud_init_template_name || 'None'}<br>
                                    <strong>License:</strong> ${t.license_product_name || 'None'}
                                </div>
                            </div>
                            <div class="card-footer">
                                <button class="btn btn-sm btn-primary w-100"
                                        onclick="showProvisionModal(${t.id}, '${t.name}')">
                                    <i data-feather="plus"></i> Provision
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            templatesLoading.classList.add('d-none');
            templatesContent.classList.remove('d-none');
            refreshFeatherIcons();
        }
    } catch (error) {
        console.error('Failed to load templates:', error);
    }
}

async function loadProviderStats() {
    try {
        const response = await csrfFetch('/api/participants/provider-stats');
        if (response.ok) {
            const data = await response.json();
            const providerStatsDiv = document.getElementById('providerStatsInfo');

            // Display provider stats
            const stats = data.providers.map(p => {
                const limit = p.max_instances > 0 ? `${p.current_count}/${p.max_instances}` : `${p.current_count} (unlimited)`;
                const badge = p.max_instances > 0 && p.current_count >= p.max_instances ?
                    '<span class="badge bg-warning text-dark ms-1">At capacity</span>' :
                    '';
                return `<strong>${p.provider}:</strong> ${limit}${badge}`;
            }).join(' | ');

            providerStatsDiv.innerHTML = `
                <div><i data-feather="activity" class="me-1" style="width: 14px; height: 14px;"></i>Provider Usage: ${stats}</div>
            `;
            refreshFeatherIcons();
        }
    } catch (error) {
        console.error('Failed to load provider stats:', error);
    }
}

async function loadMyInstances() {
    const instancesLoading = document.getElementById('instancesLoading');
    const instancesContent = document.getElementById('instancesContent');
    const instancesEmpty = document.getElementById('instancesEmpty');
    const tableBody = document.getElementById('instancesTableBody');

    try {
        const response = await csrfFetch('/api/participants/instances');

        if (response.ok) {
            const data = await response.json();

            if (data.items.length === 0) {
                instancesLoading.classList.add('d-none');
                instancesEmpty.classList.remove('d-none');
                return;
            }

            tableBody.innerHTML = data.items.map(i => {
                const statusBadge = getStatusBadge(i.status);
                const visibilityBadge = getVisibilityBadge(i.visibility);
                const canDelete = i.created_by_user_id === currentUser.id;

                return `
                    <tr>
                        <td>
                            <strong>${i.name}</strong>
                            ${i.notes ? `<br><small class="text-muted" title="${i.notes}"><i data-feather="info" class="me-1"></i>Has notes</small>` : ''}
                        </td>
                        <td>${providerIcon(i.provider)} ${i.instance_template_name || '-'}</td>
                        <td><span class="badge bg-${statusBadge}">${i.status}</span></td>
                        <td>${i.ip_address || '-'}</td>
                        <td>${i.vpn_ip || '-'}</td>
                        <td>
                            <span class="badge bg-${visibilityBadge}">${i.visibility}</span>
                            ${i.visibility !== 'private' && i.created_by_username ? `<br><small>by ${i.created_by_username}</small>` : ''}
                        </td>
                        <td>
                            ${i.notes ? `<button class="btn btn-sm btn-outline-info me-1" onclick="showNotes('${i.notes.replace(/'/g, "\\'")}')"><i data-feather="info"></i></button>` : ''}
                            ${canDelete ? `
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="showEditModal(${i.id}, '${i.name.replace(/'/g, "\\'")}', '${i.visibility}', '${(i.notes || '').replace(/'/g, "\\'")}')">
                                    <i data-feather="edit-2"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteInstance(${i.id})">
                                    <i data-feather="trash-2"></i>
                                </button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            }).join('');

            instancesLoading.classList.add('d-none');
            instancesContent.classList.remove('d-none');
            refreshFeatherIcons();

            // Find most recent sync time
            const syncTimes = data.items
                .map(i => i.last_synced_at)
                .filter(t => t)
                .sort()
                .reverse();

            if (syncTimes.length > 0) {
                const lastSync = new Date(syncTimes[0]);
                const now = new Date();
                const diffMinutes = Math.floor((now - lastSync) / 60000);
                const timeAgo = diffMinutes < 1 ? 'just now' :
                                diffMinutes === 1 ? '1 minute ago' :
                                diffMinutes < 60 ? `${diffMinutes} minutes ago` :
                                `${Math.floor(diffMinutes / 60)} hours ago`;

                // Update provider stats with last sync time
                const providerStatsDiv = document.getElementById('providerStatsInfo');
                const currentHtml = providerStatsDiv.innerHTML;
                if (currentHtml && !currentHtml.includes('Last synced:')) {
                    providerStatsDiv.innerHTML = currentHtml.replace('</div>', ` | Last synced: ${timeAgo}</div>`);
                }
            }
        }
    } catch (error) {
        console.error('Failed to load instances:', error);
    }
}

function getStatusBadge(status) {
    const map = {
        'ACTIVE': 'success',
        'BUILDING': 'warning',
        'ERROR': 'danger',
        'SHUTOFF': 'secondary',
        'DELETED': 'dark'
    };
    return map[status] || 'secondary';
}

function providerIcon(provider) {
    if (provider === 'digitalocean') {
        return `<i class="fab fa-digital-ocean" style="color: #0080FF; font-size: 16px; width: 20px; display: inline-block;" title="DigitalOcean"></i>`;
    } else if (provider === 'openstack') {
        return `<i class="fas fa-cloud" style="color: #DA1A32; font-size: 16px; width: 20px; display: inline-block;" title="OpenStack"></i>`;
    }
    return '';
}

function getVisibilityBadge(visibility) {
    const map = {
        'private': 'secondary',
        'public': 'success'
    };
    return map[visibility] || 'secondary';
}

function showProvisionModal(templateId, templateName) {
    document.getElementById('provisionTemplateId').value = templateId;
    document.getElementById('provisionModalLabel').textContent = `Provision: ${templateName}`;
    document.getElementById('provisionForm').reset();
    document.getElementById('provisionTemplateId').value = templateId; // Set again after reset
    provisionModal.show();
}

async function provisionInstance() {
    const data = {
        template_id: parseInt(document.getElementById('provisionTemplateId').value),
        name: document.getElementById('provisionName').value,
        visibility: document.getElementById('provisionVisibility').value,
        notes: document.getElementById('provisionNotes').value || null
    };

    try {
        const response = await csrfFetch('/api/participants/instances', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            provisionModal.hide();
            await refreshInstances();
            alert('Instance is being provisioned! It will appear in your list shortly.');
        } else {
            const error = await response.json();
            alert(error.detail || 'Failed to provision instance');
        }
    } catch (error) {
        console.error('Failed to provision instance:', error);
        alert('Failed to provision instance');
    }
}

async function deleteInstance(instanceId) {
    if (!confirm('Are you sure you want to delete this instance? This cannot be undone.')) {
        return;
    }

    try {
        const response = await csrfFetch(`/api/participants/instances/${instanceId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            await refreshInstances();
            alert('Instance deleted successfully');
        } else {
            const error = await response.json();
            alert(error.detail || 'Failed to delete instance');
        }
    } catch (error) {
        console.error('Failed to delete instance:', error);
        alert('Failed to delete instance');
    }
}

function showNotes(notes) {
    alert(notes);
}

function showEditModal(instanceId, instanceName, visibility, notes) {
    document.getElementById('editInstanceId').value = instanceId;
    document.getElementById('editInstanceName').value = instanceName;
    document.getElementById('editInstanceVisibility').value = visibility;
    document.getElementById('editInstanceNotes').value = notes;

    const modal = new bootstrap.Modal(document.getElementById('editInstanceModal'));
    modal.show();
}

async function saveInstanceChanges() {
    const instanceId = document.getElementById('editInstanceId').value;
    const visibility = document.getElementById('editInstanceVisibility').value;
    const notes = document.getElementById('editInstanceNotes').value;

    try {
        const response = await csrfFetch(`/api/participants/instances/${instanceId}`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                visibility: visibility,
                notes: notes || ''
            })
        });

        if (response.ok) {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editInstanceModal'));
            modal.hide();

            // Refresh instance list
            await refreshInstances();
            alert('Instance updated successfully');
        } else {
            const error = await response.json();
            alert(error.detail || 'Failed to update instance');
        }
    } catch (error) {
        console.error('Failed to update instance:', error);
        alert('Failed to update instance');
    }
}

async function refreshInstances() {
    const refreshBtn = document.querySelector('[onclick="refreshInstances()"]');
    const originalHtml = refreshBtn ? refreshBtn.innerHTML : '';

    try {
        // Show loading state
        if (refreshBtn) {
            refreshBtn.disabled = true;
            refreshBtn.innerHTML = '<i data-feather="refresh-cw" class="me-1 rotating"></i> Refreshing...';
            refreshFeatherIcons();
        }

        // Just reload the list from database
        // Background sync task handles cloud provider status updates every 2 minutes
        await loadProviderStats();
        await loadMyInstances();
    } catch (error) {
        console.error('Failed to refresh instances:', error);
    } finally {
        // Restore button state
        if (refreshBtn) {
            refreshBtn.disabled = false;
            refreshBtn.innerHTML = originalHtml;
            refreshFeatherIcons();
        }
    }
}

// Load event info and VPN status on page load
document.addEventListener('DOMContentLoaded', async function() {
    // Load event info first
    await loadEventInfo();

    // Then load VPN status (which depends on event data)
    loadVPNStatus();
    loadAvailableCount();

    // Check if VPN is available and load instance provisioning if so
    if (currentEvent && currentEvent.vpn_available) {
        document.getElementById('instanceProvisioningSection').style.display = 'block';
        provisionModal = new bootstrap.Modal(document.getElementById('provisionModal'));
        await loadAvailableTemplates();
        await loadProviderStats();
        await loadMyInstances();
    }

    // Ensure icons are rendered after initial load
    setTimeout(function() {
        refreshFeatherIcons();
    }, 100);
});
</script>
{% endblock %}
