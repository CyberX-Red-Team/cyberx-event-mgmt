# Render.com Blueprint for CyberX Event Management System
# Deploys: FastAPI app, PostgreSQL, Redis
# Estimated cost: ~$24/month

services:
  # FastAPI Web Application
  - type: web
    name: cyberx-event-mgmt
    runtime: python
    region: oregon  # Change to: oregon, frankfurt, singapore
    plan: starter  # $7/month - 512MB RAM (sufficient for 100 users)
    branch: main
    buildCommand: |
      cd backend
      pip install -r requirements.txt
    startCommand: |
      cd backend
      alembic upgrade head
      uvicorn app.main:app --host 0.0.0.0 --port $PORT --workers 2
    healthCheckPath: /health
    envVars:
      - key: PYTHON_VERSION
        value: 3.11.7
      - key: DEBUG
        value: false
      - key: DATABASE_URL
        fromDatabase:
          name: cyberx-postgres
          property: connectionString
      - key: REDIS_URL
        fromService:
          name: cyberx-redis
          type: redis
          property: connectionString
      - key: SECRET_KEY
        generateValue: true
        sync: false
      - key: CSRF_SECRET_KEY
        generateValue: true
        sync: false
      - key: ENCRYPTION_KEY
        generateValue: true
        sync: false
      - key: SENDGRID_API_KEY
        sync: false
      - key: SENDGRID_FROM_EMAIL
        sync: false
      - key: SENDGRID_FROM_NAME
        value: CyberX Red Team
      - key: SENDGRID_SANDBOX_MODE
        value: false
      - key: VPN_SERVER_PUBLIC_KEY
        sync: false
      - key: VPN_SERVER_ENDPOINT
        sync: false
      - key: VPN_DNS_SERVERS
        value: 10.20.200.1
      - key: VPN_ALLOWED_IPS
        value: 10.0.0.0/8,fd00:a::/32
      - key: FRONTEND_URL
        value: https://cyberx-event-mgmt.onrender.com
      - key: ALLOWED_HOSTS
        value: cyberx-event-mgmt.onrender.com
      - key: SESSION_EXPIRY_HOURS
        value: 24
      - key: BULK_EMAIL_INTERVAL_MINUTES
        value: 45

  # Background Worker (for scheduled jobs)
  - type: worker
    name: cyberx-worker
    runtime: python
    region: oregon
    plan: starter  # $7/month - only if you need background jobs
    branch: main
    buildCommand: |
      cd backend
      pip install -r requirements.txt
    startCommand: |
      cd backend
      python -m app.tasks.scheduler
    envVars:
      - fromService:
          name: cyberx-event-mgmt
          type: web
          envVarKey: DATABASE_URL
      - fromService:
          name: cyberx-event-mgmt
          type: web
          envVarKey: REDIS_URL
      - fromService:
          name: cyberx-event-mgmt
          type: web
          envVarKey: SECRET_KEY

databases:
  # PostgreSQL Database
  - name: cyberx-postgres
    databaseName: cyberx_events
    plan: starter  # $7/month - 1GB storage, 97 connection limit
    region: oregon
    ipAllowList: []  # Empty = allow all (secured by credentials)

  # Redis Cache
  - name: cyberx-redis
    plan: starter  # $10/month - 25MB RAM, perfect for sessions
    region: oregon
    maxmemoryPolicy: allkeys-lru  # Evict least recently used keys
    ipAllowList: []
