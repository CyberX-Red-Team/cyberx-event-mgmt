# Render.com Blueprint for CyberX Event Management System - STAGING
# Deploys: FastAPI app + Background Worker
# Uses Supabase for PostgreSQL (configured via environment variables)
# Estimated cost: ~$14/month (2x $7 services)
# Trigger: DATABASE_URL will be injected via GitHub Actions

services:
  # FastAPI Web Application - STAGING
  - type: web
    name: cyberx-event-mgmt-staging
    runtime: python
    region: virginia  # US East
    plan: starter  # $7/month - 512MB RAM (sufficient for 100 users)
    branch: staging  # Staging service watches staging branch
    autoDeploy: false  # Disable auto deploy - only deploy via GitHub Actions
    buildCommand: |
      cd backend
      pip install -r requirements.txt
    startCommand: |
      cd backend
      alembic upgrade head
      uvicorn app.main:app --host 0.0.0.0 --port $PORT --workers 2
    healthCheckPath: /health
    envVars:
      - key: PYTHON_VERSION
        value: 3.12.8
      - key: ENVIRONMENT
        value: staging
      - key: DEBUG
        value: "false"
      # Database - Supabase connection string (set manually in Render dashboard)
      - key: DATABASE_URL
        sync: false  # Managed manually in Render dashboard - do not overwrite
      # Security keys - will be auto-generated by Render
      - key: SECRET_KEY
        generateValue: true
      - key: CSRF_SECRET_KEY
        generateValue: true
      - key: ENCRYPTION_KEY
        generateValue: true
      # Email configuration
      - key: SENDGRID_API_KEY
        sync: false
      - key: SENDGRID_FROM_EMAIL
        sync: false
      - key: SENDGRID_FROM_NAME
        value: CyberX Red Team
      - key: SENDGRID_SANDBOX_MODE
        value: "true"  # STAGING: Don't send real emails
      # VPN configuration
      - key: VPN_SERVER_PUBLIC_KEY
        sync: false
      - key: VPN_SERVER_ENDPOINT
        sync: false
      - key: VPN_DNS_SERVERS
        value: 10.20.200.1
      - key: VPN_ALLOWED_IPS
        value: 10.0.0.0/8,fd00:a::/32
      # Application configuration - STAGING URLs
      - key: FRONTEND_URL
        value: https://staging.events.cyberxredteam.org
      - key: ALLOWED_HOSTS
        value: staging.events.cyberxredteam.org
      - key: SESSION_EXPIRY_HOURS
        value: 24
      - key: BULK_EMAIL_INTERVAL_MINUTES
        value: 45
      # Reminder configuration
      - key: REMINDER_1_DAYS_AFTER_INVITE
        value: 7
      - key: REMINDER_1_MIN_DAYS_BEFORE_EVENT
        value: 14
      - key: REMINDER_2_DAYS_AFTER_INVITE
        value: 14
      - key: REMINDER_2_MIN_DAYS_BEFORE_EVENT
        value: 7
      - key: REMINDER_3_DAYS_BEFORE_EVENT
        value: 3
      - key: REMINDER_CHECK_INTERVAL_HOURS
        value: 24
      # PowerDNS configuration (optional - set if using PowerDNS)
      - key: POWERDNS_API_URL
        value: ""
      - key: POWERDNS_USERNAME
        value: ""
      - key: POWERDNS_PASSWORD
        value: ""
      # Default Admin User (optional - bootstraps admin on startup)
      - key: ADMIN_EMAIL
        sync: false  # Set manually in Render dashboard
      - key: ADMIN_PASSWORD
        sync: false  # Set manually in Render dashboard
      - key: ADMIN_FIRST_NAME
        value: "Admin"
      - key: ADMIN_LAST_NAME
        value: "User"
