# Render.com Blueprint for CyberX Event Management System
# Deploys: FastAPI app + Background Worker
# Uses Supabase for PostgreSQL (configured via environment variables)
# Estimated cost: ~$14/month (2x $7 services)

services:
  # FastAPI Web Application
  - type: web
    name: cyberx-event-mgmt
    runtime: python
    region: virginia  # US East
    plan: starter  # $7/month - 512MB RAM (sufficient for 100 users)
    branch: main
    buildCommand: |
      cd backend
      pip install -r requirements.txt
    startCommand: |
      cd backend
      alembic upgrade head
      uvicorn app.main:app --host 0.0.0.0 --port $PORT --workers 2
    healthCheckPath: /health
    envVars:
      - key: PYTHON_VERSION
        value: 3.11.7
      - key: DEBUG
        value: false
      # Database - Supabase connection string (set manually in Render dashboard)
      - key: DATABASE_URL
        value: ""  # Set this to your Supabase connection string in Render dashboard
      # Security keys
      - key: SECRET_KEY
        generateValue: true
        sync: false
      - key: CSRF_SECRET_KEY
        generateValue: true
        sync: false
      - key: ENCRYPTION_KEY
        generateValue: true
        sync: false
      # Email configuration
      - key: SENDGRID_API_KEY
        sync: false
      - key: SENDGRID_FROM_EMAIL
        sync: false
      - key: SENDGRID_FROM_NAME
        value: CyberX Red Team
      - key: SENDGRID_SANDBOX_MODE
        value: false
      # VPN configuration
      - key: VPN_SERVER_PUBLIC_KEY
        sync: false
      - key: VPN_SERVER_ENDPOINT
        sync: false
      - key: VPN_DNS_SERVERS
        value: 10.20.200.1
      - key: VPN_ALLOWED_IPS
        value: 10.0.0.0/8,fd00:a::/32
      # Application configuration
      - key: FRONTEND_URL
        value: https://cyberx-event-mgmt.onrender.com
      - key: ALLOWED_HOSTS
        value: cyberx-event-mgmt.onrender.com
      - key: SESSION_EXPIRY_HOURS
        value: 24
      - key: BULK_EMAIL_INTERVAL_MINUTES
        value: 45
      # PowerDNS configuration
      - key: POWERDNS_API_URL
        sync: false
      - key: POWERDNS_USERNAME
        sync: false
      - key: POWERDNS_PASSWORD
        sync: false

  # Background Worker (for scheduled jobs)
  - type: worker
    name: cyberx-worker
    runtime: python
    region: virginia  # US East
    plan: starter  # $7/month - only if you need background jobs
    branch: main
    buildCommand: |
      cd backend
      pip install -r requirements.txt
    startCommand: |
      cd backend
      python -m app.tasks.scheduler
    envVars:
      # Share database connection from web service
      - fromService:
          name: cyberx-event-mgmt
          type: web
          envVarKey: DATABASE_URL
      - fromService:
          name: cyberx-event-mgmt
          type: web
          envVarKey: SECRET_KEY
      # Email configuration for worker
      - fromService:
          name: cyberx-event-mgmt
          type: web
          envVarKey: SENDGRID_API_KEY
      - fromService:
          name: cyberx-event-mgmt
          type: web
          envVarKey: SENDGRID_FROM_EMAIL
      - fromService:
          name: cyberx-event-mgmt
          type: web
          envVarKey: SENDGRID_FROM_NAME
